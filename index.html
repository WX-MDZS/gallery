<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>雲隠深情｜作品一覧</title>
<style>
  :root{
    --bg:#fff;
    --text:#111;
    --muted:#666;
    --ring:#9fd0df;
    --accent: rgb(103,167,186); /* R103 G167 B186 指定色 */
    --card-w:160px;   /* カード幅（固定）*/
    --card-h:190px;   /* カード高さ（固定）*/
    --icon:100px;     /* アイコン直径 */
    --gap:28px;       /* カード間のすき間 */
    --radius:14px;    /* カード角丸 */
  }

  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic UI","Yu Gothic","Noto Sans JP","Meiryo",sans-serif}

  header{ text-align:center; padding:18px 16px 6px }
  header img{ width:min(560px,86vw); height:auto; display:block; margin:0 auto }

  h1{ display:none }
  h2{ text-align:center; margin:10px 0 4px; font-size:clamp(18px,3.7vw,26px)}
  .desc{ text-align:center; color:var(--muted); font-size:.95rem; margin:0 0 10px }

  .counter{ text-align:center; margin:8px 0 22px; font-weight:700; font-size:clamp(16px,3.6vw,20px)}
  .counter .num{ font-variant-numeric: tabular-nums; letter-spacing:.06em }

  /* 固定サイズのグリッド：PC 4列 / モバイル 2列。横スクロール防止 */
  .gallery{
    display:grid;
    grid-template-columns: repeat(4, var(--card-w));
    gap: var(--gap);
    justify-content:center;
    padding: 6px 16px 60px;
  }
  @media (max-width:680px){
    .gallery{ grid-template-columns: repeat(2, var(--card-w)); gap:22px }
  }

  /* ===== カード（固定サイズで縮まない） ===== */
  .card{
    width:var(--card-w);
    height:var(--card-h);
    background:#fff;
    border:1px solid #e9eef2;
    border-radius:var(--radius);
    box-shadow:0 1px 2px rgba(0,0,0,.04);
    padding:10px 6px 8px;
    text-align:center;
    position:relative;
  }
  .card:focus-within,
  .card:hover{
    transform:translateY(-2px);
    transition:transform .12s ease;
    box-shadow:0 10px 24px rgba(0,0,0,.08);
  }

  /* アイコン */
  .icon-wrap{ position:relative; display:inline-block; }
  .icon{
    width:var(--icon);
    height:var(--icon);
    border-radius:50%;
    display:block;
    object-fit:cover;
    background:#f3f4f6;
    filter:drop-shadow(0 0 0 var(--ring));
    border:2px solid #cfe8f2;
  }
  .card:hover .icon,
  .card:focus-within .icon{
    transform:scale(1.04);
    transition: transform .18s;
    box-shadow:0 12px 28px rgba(0,0,0,.12);
  }

  /* ポップアップ（名前の少し上あたり = 下寄り） */
  .pop{
    position:absolute;
    left:50%;
    top:62%;                 /* ←位置微調整：もう少し下にしたい時は数値を大きく */
    transform:translateX(-50%) scale(.98);
    background:#fff;
    border:1px solid var(--ring);
    border-radius:10px;
    padding:.38rem .5rem;
    display:flex;
    gap:.4rem;
    box-shadow:0 10px 24px rgba(0,0,0,.08);
    opacity:0;
    pointer-events:none;
    transition:opacity .16s, transform .16s;
    z-index:10;
    white-space:nowrap;
  }
  .card:hover .pop,
  .card.pop-open .pop{ opacity:1; transform:translateX(-50%) scale(1); pointer-events:auto }

  /* ボタン（横並び） */
  .pill{
    display:inline-block;
    min-width:46px;
    padding:.28rem .56rem;
    border-radius:999px;
    font-size:.85rem;
    text-decoration:none;
    color:var(--accent);
    border:1px solid var(--accent);
    background:#f8fafc;
    line-height:1;
    transition: background .12s, color .12s, border-color .12s;
  }
  .pill:hover{ background: rgba(103,167,186,.15) }

  /* 名前（2行まで／省略） */
  .name{
    position:absolute;
    left:0; right:0;
    bottom:8px;
    padding:0 .5rem;
    font-weight:700;
    font-size:.95rem;
    line-height:1.1;
    display:-webkit-box;
    -webkit-line-clamp:2;
    -webkit-box-orient:vertical;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  footer{ text-align:center; color:#777; font-size:.9rem; padding: 16px 0 26px }
</style>
</head>
<body>
<header>
  <!-- ロゴは大きすぎないようにmax幅で制御 -->
  <img src="assets/title.jpg" alt="雲隠深情">
</header>

<h1>雲隠深情</h1>
<h2>作品一覧</h2>
<p class="desc">アイコン＝X、ポップアップのボタン＝作品・感想</p>

<p class="counter">あなたは<span id="visitor" class="num">000000</span>人目の姑蘇藍氏の先輩</p>

<div id="gallery" class="gallery" aria-live="polite"></div>

<footer>雲隠探情企画 / 主催はくと</footer>

<script>
/* ===== 設定（CSVのURLだけ必要に応じて差し替え） ===== */
const CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQLr1090BcgO8C08pdp3UHuN73zUFB68OyW47BSihAvvVxbwDtMBwK0st9tJpg8nqpNTR0m4QHjcVs4/pub?gid=0&single=true&output=csv";

/* アイコン拡張子の優先順（pngなければjpgを自動フォールバック） */
const ICON_EXTS = ["png", "jpg", "jpeg", "webp"];

/* ===== カウンター（localStorage） ===== */
(function(){
  const el = document.getElementById('visitor');
  let n = Number(localStorage.getItem('visitCount') || 0) + 1;
  localStorage.setItem('visitCount', n);
  el.textContent = String(n).padStart(6,'0');
})();

/* ===== CSV 読み込み & 描画 ===== */
(async function init(){
  const rows = await loadCSV(CSV_URL);
  // 期待列: A=icon名(拡張子不要/あってもOK), B=名前, C=Xリンク, D=作品, E=感想
  // 先頭行もデータとして扱う（ヘッダーっぽい文字列は飛ばすロジックを緩め）
  const data = [];
  for(const r of rows){
    if(!r) continue;
    const A = (r[0]||"").trim();
    const B = (r[1]||"").trim();
    const C = (r[2]||"").trim();
    const D = (r[3]||"").trim();
    const E = (r[4]||"").trim();
    const allEmpty = !A && !B && !C && !D && !E;
    if(allEmpty) continue;

    // 典型的ヘッダー語を検出したらスキップ（ただし EastBud 等の実データは通す）
    const joined = (A+B+C+D+E).toLowerCase();
    const looksHeader = /icon|アイコン|name|名前|twitter|作品|感想/.test(joined);
    if(looksHeader) continue;

    data.push({icon:A,name:B,x:C,work:D,fb:E});
  }
  render(data);
})();

/* ===== CSVパーサ（ダブルクオート対応の簡易版） ===== */
async function loadCSV(url){
  const text = await fetch(url, {cache:"no-store"}).then(r=>r.text());
  // 改行で分割
  const lines = text.replace(/\r/g,'\n').split('\n').filter(l=>l.trim().length>0);
  // CSV 1行を「クオート対応」で分割する正規表現
  const splitter = /,(?=(?:[^"]*"[^"]*")*[^"]*$)/g;
  return lines.map(line=>{
    return line.split(splitter).map(cell=>{
      cell = cell.trim();
      if(cell.startsWith('"') && cell.endsWith('"')){
        cell = cell.slice(1,-1).replace(/""/g,'"');
      }
      return cell;
    });
  });
}

/* ===== 描画 ===== */
function render(items){
  const wrap = document.getElementById('gallery');
  wrap.textContent = '';

  items.forEach((it, idx)=>{
    const card = document.createElement('div');
    card.className = 'card';

    // アイコン画像（拡張子フォールバック）
    const iconWrap = document.createElement('div');
    iconWrap.className = 'icon-wrap';

    const img = document.createElement('img');
    img.className = 'icon';

    // sheet には "01" などが入っている想定。拡張子が付いていたら尊重。
    let base = (it.icon || String(idx+1)).trim();
    let explicitExt = '';
    const dot = base.lastIndexOf('.');
    if(dot>0){ explicitExt = base.slice(dot+1).toLowerCase(); base = base.slice(0,dot); }

    const sources = explicitExt ? [explicitExt] : ICON_EXTS;
    let srcIdx = 0;
    img.src = `icons/${base}.${sources[srcIdx]}`;
    img.alt = it.name || '';

    img.onerror = function(){
      srcIdx++;
      if(srcIdx < sources.length){
        img.src = `icons/${base}.${sources[srcIdx]}`;
      }
    };

    // アイコンをクリック → X(Twitter) へ
    if(it.x){
      img.style.cursor = 'pointer';
      img.addEventListener('click', ()=> window.open(it.x, '_blank'));
    }

    iconWrap.appendChild(img);
    card.appendChild(iconWrap);

    // ポップアップ（横並びボタン）
    const pop = document.createElement('div');
    pop.className = 'pop';

    if(it.work){
      const a = document.createElement('a');
      a.className = 'pill';
      a.textContent = '作品';
      a.href = it.work;
      a.target = '_blank';
      a.rel = 'noopener';
      pop.appendChild(a);
    }
    if(it.fb){
      const b = document.createElement('a');
      b.className = 'pill';
      b.textContent = '感想';
      b.href = it.fb;
      b.target = '_blank';
      b.rel = 'noopener';
      pop.appendChild(b);
    }
    card.appendChild(pop);

    // 名前
    const name = document.createElement('div');
    name.className = 'name';
    name.textContent = it.name || '';
    card.appendChild(name);

    // タッチ端末向け（1タップで開く/外をタップで閉じる）
    card.addEventListener('touchstart', (e)=>{
      if(!card.classList.contains('pop-open')){
        card.classList.add('pop-open');
        setTimeout(()=> document.addEventListener('touchstart', closeOnOutside, {once:true, passive:true}), 0);
      }
    }, {passive:true});

    function closeOnOutside(ev){
      if(!card.contains(ev.target)) card.classList.remove('pop-open');
    }

    // キーボードEscで閉じる
    card.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape') card.classList.remove('pop-open');
    });

    wrap.appendChild(card);
  });
}
</script>
</body>
</html>
