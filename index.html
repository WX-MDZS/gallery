<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>雲隠深情 | 作品一覧</title>
<style>
:root{
  --accent: rgb(103,167,186);
  --ring: rgba(0,0,0,.08);
  --pill-bg: #f8fafc;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:#fff;color:#222;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo,sans-serif}
a{color:inherit}
img{max-width:100%;display:block}

header{padding:24px 12px 8px;text-align:center}
header .title{width:min(920px,92vw);margin:0 auto}

main{max-width:980px;margin:0 auto;padding:8px 12px 56px}

/* 見出し・説明・カウンタ */
h2{margin:8px 0 4px;text-align:center;font-size:clamp(20px,2.6vw,28px)}
.desc{margin:4px 0 16px;text-align:center;color:#666}
.counter{margin:2px 0 28px;text-align:center;font-weight:700}
.counter .num{letter-spacing:.08em;font-variant-numeric:tabular-nums}

/* グリッド（PC=4列, SP=2列） */
.gallery{display:grid;gap:18px;justify-content:center}
@media (min-width:901px){
  .gallery{grid-template-columns:repeat(4, 1fr);max-width:920px;margin-inline:auto}
}
@media (max-width:900px){
  .gallery{grid-template-columns:repeat(2, 1fr);max-width:460px;margin-inline:auto}
}

/* カードは固定サイズ（正方形寄り） */
.card{
  position:relative;
  width:220px;height:230px;  /* ←固定。幅を変えても伸びない */
  background:#fff;border-radius:16px;
  box-shadow:0 2px 10px var(--ring);
  padding-top:18px; /* 上に少し余白 */
  margin:0 auto;
}
.icon-wrap{position:relative;display:flex;justify-content:center}
.icon{
  width:118px;height:118px;border-radius:50%;
  object-fit:cover;background:#f3f4f6;
  border:4px solid #cfe7f2; /* 外輪 */
  box-shadow:0 10px 22px rgba(0,0,0,.06);
  transition:transform .16s ease, filter .16s ease;
}
.card:hover .icon{transform:translateY(-2px);filter:saturate(1.04)}

/* ボタン（ポップアップ） … アイコンのすぐ下に横並び */
.pop{
  position:absolute;left:50%;transform:translateX(-50%);
  top: calc(18px + 118px + 6px); /* padding-top + icon高さ + 間隔 */
  display:flex;gap:10px;
  background:#fff;border-radius:10px;
  padding:6px 10px;
  box-shadow:0 10px 24px rgba(0,0,0,.08);
  border:1px solid var(--ring);
  pointer-events:none;opacity:0;transition:opacity .15s ease, transform .15s ease;
}
.card:hover .pop,
.card.card-open .pop{opacity:1;transform:translateX(-50%) translateY(-2px);pointer-events:auto}

.pill{
  display:inline-block;font-size:.9rem;padding:.35rem .7rem;
  border-radius:999px;border:1px solid var(--accent);background:var(--pill-bg);
  color:var(--accent);text-decoration:none;user-select:none;
  transition:background .12s,border-color .12s, transform .12s;
}
.pill:hover{background:rgba(103,167,186,.14)}
.pill:active{transform:translateY(1px)}

/* 名前（黒リンク） */
.name{
  margin-top:58px; /* ボタンの下に余白 */
  text-align:center;font-weight:700;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.name a{text-decoration:none;color:#000}

/* クリックの逃し防止（モバイルで1回タップで開き、外をタップで閉じる） */
.card{touch-action:manipulation}

/* ===== 背景：下固定（スクロールしても動かない） ===== */
body::after{
  content:"";
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  /* 画像パス */
  background: url("./assets/haikei.jpg") center bottom / cover no-repeat;
  /* 表示する高さ（画面に応じて可変） */
  height: min(42vh, 380px);
  z-index: -1;           /* すべての要素の背面へ */
  pointer-events: none;  /* クリック/スクロールの邪魔をしない */
}
/* ポップアップのボタンを横並び固定にする */
.pop{
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: center;
  gap: .6rem;              /* ボタン間のすき間 */
  white-space: nowrap;     /* 改行させない */
  min-width: 172px;        /* 2ボタン分の最低幅（必要なら調整） */
  padding: .35rem .6rem;
}

/* 念のためボタン側も改行禁止＆横並びに強める */
.pop .pill{
  display: inline-flex;
  align-items: center;
  justify-content: center;
  white-space: nowrap;
}
  
</style>
</head>
<body>

<header>
  <img class="title" src="./assets/title.jpg" alt="雲隠深情">
</header>

<main>
  <h2>作品一覧</h2>
  <p class="desc">アイコン＝Twitter、ポップアップのボタン＝作品・感想</p>
  <p class="counter">あなたは「<span class="num" id="vis">000000</span>」人目の姑蘇藍氏の弟子</p>

  <div id="gallery" class="gallery" aria-live="polite"></div>

  <p style="text-align:center;margin-top:28px;color:#666">雲隠探情企画 / 主催はくと</p>
</main>

<script>
/* ====== 設定 ====== */
const CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQLr1090BcgO8C08pdp3UHuN73zUFB68OyW47BSihAvvVxbwDtMBwK0st9tJpg8nqpNTR0m4QHjcVs4/pub?gid=0&single=true&output=csv";
const IMG_DIR = "icons"; // 小文字フォルダ名推奨

/* ====== ユーティリティ ====== */
const $ = (sel, el=document) => el.querySelector(sel);

function zpad(n, len=6){ return String(n).padStart(len,'0'); }

function buildIconCandidates(raw){
  const v = (raw||"").trim();
  if(!v) return [`${IMG_DIR}/placeholder.png`];
  // ファイル名にスラッシュ・プロトコルがあればそのまま使う
  if (/^https?:\/\//i.test(v)) return [v];
  // 既に拡張子付き
  if (/\.(png|jpg|jpeg|webp|gif)$/i.test(v)) {
    return [`${IMG_DIR}/${encodeURIComponent(v)}`];
  }
  const base = encodeURIComponent(v);
  return [
    `${IMG_DIR}/${base}.png`,
    `${IMG_DIR}/${base}.jpg`,
    `${IMG_DIR}/${base}.jpeg`,
    `${IMG_DIR}/${base}.webp`,
    `${IMG_DIR}/${base}.gif`,
  ];
}

function setIconWithFallback(imgEl, list){
  let i = 0;
  const next = ()=> {
    if(i >= list.length){
      // 最終フォールバック（透明1px）
      imgEl.src='data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==';
      return;
    }
    imgEl.src = list[i++];
  };
  imgEl.onerror = next;
  next();
}

/* ====== カード生成 ====== */
function createCard(row){
  // row: [icon, name, twitter, work, feedback]
  const [iconRaw, nameRaw, twRaw, work, fb] = row;
  const name = (nameRaw||"").trim();
  const twitter = (twRaw||"").trim();

  const card = document.createElement('div');
  card.className = 'card';

  // アイコン
  const wrap = document.createElement('div');
  wrap.className = 'icon-wrap';
  const img = document.createElement('img');
  img.alt = name || 'icon';
  img.className = 'icon';
  setIconWithFallback(img, buildIconCandidates(iconRaw));
  wrap.appendChild(img);
  card.appendChild(wrap);

  // ボタン（ポップアップ）
  const pop = document.createElement('div');
  pop.className = 'pop';
  const btnWork = document.createElement('a');
  btnWork.className = 'pill';
  btnWork.textContent = '作品';
  if (work) { btnWork.href = work; btnWork.target = '_blank'; btnWork.rel = 'noopener'; }
  else { btnWork.href = 'javascript:void(0)'; }

  const btnFb = document.createElement('a');
  btnFb.className = 'pill';
  btnFb.textContent = '感想';
  if (fb) { btnFb.href = fb; btnFb.target = '_blank'; btnFb.rel = 'noopener'; }
  else { btnFb.href = 'javascript:void(0)'; }

  pop.appendChild(btnWork);
  pop.appendChild(btnFb);
  card.appendChild(pop);

  // 名前（黒リンク：Twitter）
  const nm = document.createElement('div');
  nm.className = 'name';
  if (twitter){
    const a = document.createElement('a');
    a.href = twitter; a.target = '_blank'; a.rel = 'noopener';
    a.textContent = name || twitter;
    nm.appendChild(a);
  }else{
    nm.textContent = name || '';
  }
  card.appendChild(nm);

  // モバイル：1タップで開閉（アイコンはリンクしない）
  card.addEventListener('touchstart', (e)=>{
    if(!card.classList.contains('card-open')){
      card.classList.add('card-open');
      // 外側タップで閉じる
      const closeOnce = (ev)=>{
        if(!card.contains(ev.target)){
          card.classList.remove('card-open');
          document.removeEventListener('touchstart', closeOnce);
        }
      };
      document.addEventListener('touchstart', closeOnce, {passive:true, once:true});
    }
  }, {passive:true});

  return card;
}

/* ====== CSV 読み込み ====== */
async function loadCSV(url){
  const res = await fetch(url + '&_=' + Date.now()); // キャッシュ潰し
  const text = await res.text();
  const lines = text.replace(/^\uFEFF/, '').split(/\r?\n/);

  const rows = [];
  for (const ln of lines){
    if(!ln.trim()) continue;
    const cols = ln.split(',').map(s=>s.trim());
    // ヘッダっぽい行をスキップ（A列がヘッダ名、または「アイコン」など）
    const a = (cols[0]||'').trim();
    if (/^A|アイコン|icon$/i.test(a)) continue;
    rows.push(cols);
  }
  return rows;
}

/* ====== 起動 ====== */
async function init(){
  // 訪問カウンタ
  try{
    let n = Number(localStorage.getItem('visitCount')||0) + 1;
    localStorage.setItem('visitCount', n);
    $('#vis').textContent = zpad(n, 6);
  }catch(_){}

  // CSV → カード
  const gallery = $('#gallery');
  gallery.textContent = ''; // クリア
  try{
    const data = await loadCSV(CSV_URL);
    // 32人分想定、空行などは弾く（アイコンと名前が空は除外）
    const cleaned = data.filter(r => (r[0]||'').trim() || (r[1]||'').trim());
    cleaned.forEach(row => gallery.appendChild(createCard(row)));
  }catch(err){
    console.error(err);
    const p = document.createElement('p');
    p.textContent = 'CSVの読み込みでエラーが発生しました。しばらくして再読み込みしてください。';
    p.style.textAlign = 'center';
    gallery.appendChild(p);
  }
}
init();
</script>
</body>
</html>


