<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>雲隠深情 | 作品一覧</title>
<style>
:root{
  --accent: rgb(103,167,186);
  --shadow: 0 10px 24px rgba(0,0,0,.08);
  --shadow-hover: 0 18px 36px rgba(0,0,0,.14);
  --icon-size: 108px;

  /* カード幅と間隔（赤い余白を削った版） */
  --card-w: 200px;
  --gap: 16px;
}

/* base */
*{box-sizing:border-box}
html,body{background:#fff;color:#222;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Sans",Meiryo,sans-serif}
body{margin:0;padding:0 0 64px;text-align:center}

/* header */
header{padding:22px 10px 8px}
header img{width:min(880px,92vw);height:auto;display:block;margin:0 auto}

/* 見出し/説明 */
.counter{
  margin: 8px auto 6px;
  width:min(920px,92vw);
  font-weight:900;
  font-size: clamp(22px, 3.0vw, 32px);
}
.counter .num{letter-spacing:.06em}
.lead{margin: 4px 0 0; font-size:.95rem; color:#555;}
.section-title{
  margin: 18px 0 22px;
  font-size: clamp(20px, 2.4vw, 28px);
  font-weight:800;
}
.notice{
  background:#fff9e6;border:1px solid #f2e2b6;color:#7a5a00;
  width:min(1000px,92vw);margin:0 auto 16px;padding:12px 14px;
  border-radius:12px;text-align:left;display:none;
}

/* ===== Grid =====
   PC=4列を常に維持（幅が足りなければ横スクロール）。
   横スクロールバーは“非表示”。影が切れないように内側パディングを追加。 */
.wrap{
  --wrap-w: calc(var(--card-w)*4 + var(--gap)*3);
  width: var(--wrap-w);
  max-width: 100vw;
  margin: 0 auto;

  /* 横はスクロール可だがバーは非表示 */
  overflow-x: auto;
  overflow-y: visible;

  /* 影が切れない余白：左右/下に十分なパディング */
  padding: 0 40px 56px;
  box-sizing: content-box;

  /* スクロールバー非表示（各ブラウザ） */
  -ms-overflow-style: none;
  scrollbar-width: none;
}
.wrap::-webkit-scrollbar{ display:none }

.gallery{
  display:grid;
  grid-template-columns: repeat(4, var(--card-w));
  gap: var(--gap);
}

/* スマホのみ 2 列：pointer:coarse を条件に（PC細窓では発動しない） */
@media (max-width: 860px) and (pointer: coarse){
  .wrap{
    width: min(480px, 96vw);
    overflow-x: hidden;
    padding: 0 16px 48px;
  }
  .gallery{ grid-template-columns: repeat(2, 1fr); gap: 16px; }
  :root{ --icon-size: 104px; }
}

/* card */
.card{
  position:relative;
  background:#fff;
  border-radius:16px;
  width: var(--card-w);
  padding: 12px 8px 14px;
  box-shadow: var(--shadow);
  transition: box-shadow .2s ease, transform .2s ease;
}
.card:hover{ box-shadow: var(--shadow-hover); transform: translateY(-2px); }
@media (max-width: 860px) and (pointer: coarse){
  .card{ width:auto; }
}

/* icon */
.icon-wrap{
  width: var(--icon-size);
  height: var(--icon-size);
  margin: 2px auto 6px;
  border-radius:50%;
  overflow:hidden;
  border:4px solid rgba(103,167,186,.28);
  outline:2px solid var(--accent);
  outline-offset:-6px;
  background:#f3f4f6;
  position:relative;
  transition: filter .18s;
}
.icon-wrap:hover{ filter: saturate(1.04) }
.icon{width:100%;height:100%;object-fit:cover;display:block}

/* ポップアップ（アイコン下 1/3 に重ね、カード下にも出る） */
.pop{
  display:flex; gap:10px; justify-content:center; align-items:center;
  position:absolute; left:50%;
  top: calc(var(--icon-size) * 0.83);
  transform: translate(-50%, -30%);
  padding:6px 8px; border-radius:12px; background:#fff;
  border:1px solid rgba(0,0,0,.08); box-shadow:0 10px 24px rgba(0,0,0,.14);
  z-index:10; opacity:0; pointer-events:none;
  transition: opacity .18s ease, transform .18s ease;
}
.card:hover .pop,
.card.pop-open .pop{ opacity:1; pointer-events:auto; }

/* ボタン（太字・指定色） */
.pill{
  display:inline-block; min-width:62px; padding:.36rem .66rem;
  border-radius:999px; line-height:1; border:1px solid var(--accent);
  color:var(--accent); background:#fff; text-decoration:none;
  font-size:.92rem; font-weight:700; white-space:nowrap;
  box-shadow:0 2px 0 rgba(103,167,186,.08);
  transition:background .12s, transform .06s;
}
.pill:hover{ background:rgba(103,167,186,.12) }
.pill:active{ transform:translateY(1px) }

/* 名前 */
.name{ margin: 18px 0 4px; font-weight:700; font-size:1.00rem; }
.name a{ color:#111; text-decoration:none; }
.name a:focus-visible{ outline:2px solid var(--accent) }

/* footer */
footer{margin:28px 0 0; color:#666; font-size:.9rem}
</style>
</head>
<body>

<header>
  <img src="./assets/title.jpg" alt="雲隠深情">
</header>

<p class="counter">
  あなたは<strong class="num" id="visitor">000000</strong>人目の姑蘇藍氏の先輩
</p>
<p class="lead">お名前＝X、ポップアップのボタン＝作品・感想</p>
<p class="lead">ぜひ各作家さんに感想をお願いします。</p>

<h1 class="section-title">エピソード一覧</h1>

<p id="notice" class="notice"></p>

<div class="wrap">
  <section id="gallery" class="gallery" aria-live="polite"></section>
</div>

<footer>雲隠探情企画 / 主催はくと</footer>

<script>
/* ===== 設定 ===== */
const CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQLr1090BcgO8C08pdp3UHuN73zUFB68OyW47BSihAvvVxbwDtMBwK0st9tJpg8nqpNTR0m4QHjcVs4/pub?output=csv";

/* カウンターAPI（GAS WebアプリURLに差し替え） */
const COUNTER_API = "https://script.google.com/macros/s/~~~~YOUR_DEPLOYED_EXEC_URL~~~~/exec";

/* 表示だけ固定したい場合は 6 桁文字列。固定しないなら null */
const COUNTER_FIXED = null;

/* ===== CSV ロード ===== */
async function loadCSV(url){
  const res = await fetch(url, {cache:'no-store'});
  const text = await res.text();
  const lines = text.replace(/^\uFEFF/,'').trim().split(/\r?\n/);
  if(!lines.length) return [];

  const expected = ["アイコン","名前","ツイッター","作品","感想"];
  const rawHeader = lines[0].split(',').map(s=>s.trim());
  let header = rawHeader;
  if (rawHeader.join('/') !== expected.join('/')) {
    header = expected;
    const n = document.getElementById('notice');
    n.style.display = 'block';
    n.textContent = "CSVの見出しが判定できなかったため、列の並び（アイコン/名前/ツイッター/作品/感想）で推測して読み込みました。見出しを付け直すとより安全です。";
  }

  return lines.slice(1).map(line=>{
    const cols = line.split(',').map(s=>s.trim());
    const obj = {};
    header.forEach((h,i)=> obj[h] = (cols[i]||"").trim());
    return obj;
  });
}

/* ===== カード生成 ===== */
function makeCard({アイコン, 名前, ツイッター, 作品, 感想}){
  const card = document.createElement('div');
  card.className = 'card';

  const iconWrap = document.createElement('div');
  iconWrap.className = 'icon-wrap';
  const img = document.createElement('img');
  img.className = 'icon';
  img.alt = `${名前} のアイコン`;
  img.src = `./icons/${アイコン}`;
  iconWrap.appendChild(img);
  card.appendChild(iconWrap);

  const pop = document.createElement('div');
  pop.className = 'pop';
  const a1 = document.createElement('a');
  a1.className = 'pill'; a1.href = 作品 || '#'; a1.target = '_blank'; a1.rel = 'noopener'; a1.textContent = '作品';
  const a2 = document.createElement('a');
  a2.className = 'pill'; a2.href = 感想 || '#'; a2.target = '_blank'; a2.rel = 'noopener'; a2.textContent = '感想';
  pop.appendChild(a1); pop.appendChild(a2);
  card.appendChild(pop);

  const name = document.createElement('div');
  name.className = 'name';
  const tw = document.createElement('a');
  tw.href = ツイッター || '#'; tw.target = '_blank'; tw.rel = 'noopener'; tw.textContent = 名前 || '';
  name.appendChild(tw);
  card.appendChild(name);

  // モバイル：タップで開閉
  iconWrap.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); card.classList.toggle('pop-open'); });
  iconWrap.tabIndex = 0;
  iconWrap.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); card.classList.toggle('pop-open'); }});
  document.addEventListener('click', (e)=>{ if(!card.contains(e.target)) card.classList.remove('pop-open'); });

  return card;
}

/* ===== カウンター（GAS API 使用） ===== */
function setCountText(n){
  document.getElementById('visitor').textContent = String(n).padStart(6,'0');
}

async function fetchCounter(method='GET'){
  const res = await fetch(COUNTER_API, { method, mode:'cors' });
  const data = await res.json();
  if (data && typeof data.count === 'number') setCountText(data.count);
  return data;
}

async function updateCounterWithAPI(csvRows){
  // 固定表示指定があれば最優先
  if (COUNTER_FIXED && /^\d{6}$/.test(COUNTER_FIXED)) {
    setCountText(Number(COUNTER_FIXED));
    return;
  }

  const VISIT_KEY = 'mdzs_visit_24h';
  const last = Number(localStorage.getItem(VISIT_KEY) || 0);
  const now  = Date.now();
  const oneDay = 24*60*60*1000;

  try{
    // まず現在値をGETして即表示
    await fetchCounter('GET');

    // 24時間以上あいていれば +1
    if (!last || now - last > oneDay) {
      await fetchCounter('POST');
      localStorage.setItem(VISIT_KEY, String(now));
    }
  }catch(_){
    // API失敗時はフォールバック：CSV件数を表示
    const count = csvRows.length;       // ←必要なら Math.min(32, csvRows.length) に戻せる
    setCountText(count);
  }
}

/* ===== init ===== */
(async ()=>{
  try{
    const rows = await loadCSV(CSV_URL);

    // カード描画（4×8 = 32 件まで）
    const gallery = document.getElementById('gallery');
    gallery.innerHTML = '';
    rows.slice(0,32).forEach(r => gallery.appendChild(makeCard(r)));

    // カウンター更新（GAS API + フォールバック）
    await updateCounterWithAPI(rows);
  }catch(err){
    console.error(err);
    const n = document.getElementById('notice');
    n.style.display = 'block';
    n.textContent = 'CSVの読み込みに失敗しました。時間をおいて再読み込みしてください。';
  }
})();
</script>
</body>
</html>
