<!doctype html>
<html lang="ja">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>雲隠深情 | 作品一覧</title>
<style>
:root{
  --ring: #67a7ba;      /* R103 G167 B186 */
  --muted: #888;
  --shadow: 0 8px 26px rgba(0,0,0,.08);
}

*{box-sizing:border-box}
body{margin:0;font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;color:#222;background:#fff}

header{padding:24px 16px 8px;text-align:center}
header img{max-width:980px;width:86vw;height:auto;display:block;margin:0 auto}

main{max-width:1100px;margin:0 auto;padding:8px 16px 48px;text-align:center}

h1{font-size:clamp(22px,2.6vw,32px);margin:6px 0 8px}
.lead{color:var(--muted);font-size:.95rem;margin:0 0 14px}
.counter{font-weight:700;margin:10px 0 28px}
.footer{margin:48px 0 12px;color:#777;font-size:.9rem}

/* ===== カード ===== */
.gallery{
  display:grid;
  grid-template-columns:repeat(4, 1fr);
  gap:22px;
  padding:10px 4px 0;
}
@media (max-width: 780px){
  .gallery{grid-template-columns:repeat(2, 1fr)}
}

.card{
  background:#fff;
  border:1px solid #eef2f5;
  border-radius:18px;
  padding:18px 10px 14px;
  box-shadow:var(--shadow);
  transition:transform .15s ease, box-shadow .15s ease;
}
.card:hover{transform:translateY(-2px); box-shadow:0 14px 38px rgba(0,0,0,.12)}

/* アイコン＋ポップアップ一式（縦積みセンター） */
.stack{
  display:flex;flex-direction:column;align-items:center;gap:10px;
}

/* アイコン */
.icon{
  width:120px;height:120px;border-radius:50%;object-fit:cover;display:block;
  border:4px solid #d2ecf4; outline:2px solid var(--ring);
  box-shadow:0 12px 26px rgba(0,0,0,.08);
  transition:filter .15s ease, transform .15s ease, box-shadow .15s ease;
}
.card:hover .icon{box-shadow:0 16px 38px rgba(0,0,0,.12)}

/* ここが“アイコン直下のポップアップ” */
.actions{
  display:flex;gap:10px;justify-content:center;align-items:center;
}

/* ボタン：カラーはR103 G167 B186 */
.pill{
  display:inline-block;
  min-width:70px;
  padding:.42rem .7rem;
  border-radius:999px;
  border:1px solid var(--ring);
  color:var(--ring);
  background:#fff;
  text-decoration:none;
  font-weight:700;
  transition:background .12s, box-shadow .12s, transform .12s;
  box-shadow:0 2px 6px rgba(0,0,0,.06);
}
.pill:hover{background:rgba(103,167,186,.12); box-shadow:0 6px 16px rgba(0,0,0,.10)}
/* モバイルで誤タップ軽減（指タップ時にだけ影強め） */
@media (hover:none){
  .pill:active{transform:translateY(1px); box-shadow:0 4px 10px rgba(0,0,0,.16)}
}

/* 名前（Twitterリンク） */
.name{
  margin:8px 0 0;
  font-weight:800;
  color:#000;               /* 黒のまま */
  text-decoration:none;
  display:inline-block;
}
.name:hover{text-decoration:underline}

/* 目立つエラー */
.err{
  margin:12px auto 6px;max-width:760px;
  border:1px solid #f5c2c7;background:#fff5f6;color:#842029;border-radius:12px;
  padding:10px 12px;font-size:.95rem;display:none;
}
</style>

<body>
  <header>
    <img src="assets/title.jpg" alt="雲隠深情">
  </header>

  <main>
    <h1>作品一覧</h1>
    <p class="lead">アイコン＝Twitter、ポップアップのボタン＝作品・感想</p>
    <p class="counter">あなたは「<span id="vc">000000</span>」人目の姑蘇藍氏の弟子</p>

    <div id="err" class="err"></div>
    <section id="g" class="gallery" aria-live="polite"></section>

    <p class="footer">雲隠探情企画 / 主催はくと</p>
  </main>

<script>
/* ================= ここだけ必要に応じて変更 ================= */
const CSV_URL = "";  // ← ここに公開CSVの「ダウンロードURL（format=csv）」を入れてOK。空なら自動フォールバック
const FALLBACK_COUNT = 32; // 画像が 01.png〜32.png まである想定
/* =========================================================== */

const elG   = document.getElementById('g');
const elErr = document.getElementById('err');
const elVC  = document.getElementById('vc');

/* 訪問者カウンタ（localStorage 6桁ゼロ詰め） */
try{
  const k="visitCount_mdzs";
  let n = +localStorage.getItem(k) || 0;
  localStorage.setItem(k, ++n);
  elVC.textContent = String(n).padStart(6,"0");
}catch{}

/* CSV を読んでカードを描画。失敗 or 0件ならフォールバック */
(async function init(){
  let rows = [];
  try{
    if (CSV_URL){
      const res = await fetch(CSV_URL, {cache:"no-store"});
      if(!res.ok) throw new Error("CSV fetch failed: "+res.status);
      const text = await res.text();
      rows = parseCSV(text);
    }
  }catch(e){
    console.warn(e);
    tell("CSVの取得に失敗しました。フォールバックで表示します。");
  }

  // ヘッダ推定＆マッピング
  let data = [];
  if (rows.length){
    const hdr = rows[0].map(s=>s.trim());
    const idx = {
      name: pickIndex(hdr, ["名前","name","おなまえ","作家名"]),
      icon: pickIndex(hdr, ["アイコン","icon","画像","img"]),
      work: pickIndex(hdr, ["作品","work","サイト","URL1"]),
      feel: pickIndex(hdr, ["感想","form","感想フォーム","URL2"]),
      x   : pickIndex(hdr, ["X","twitter","ツイッター","SNS"]),
    };
    const ok = idx.name>-1 && idx.icon>-1;
    if(!ok) tell("CSVは読めましたが、列名が見つかりませんでした（必要: 名前 / アイコン）。フォールバックで表示します。");
    else{
      for (let i=1;i<rows.length;i++){
        const r=rows[i]; if(!r || !r.length) continue;
        const name = (r[idx.name]||"").trim();
        const icon = (r[idx.icon]||"").trim();
        if(!name && !icon) continue;
        data.push({
          name: name || "no name",
          icon: fixIcon(icon),
          work: (idx.work>-1 ? (r[idx.work]||"").trim() : ""),
          feel: (idx.feel>-1 ? (r[idx.feel]||"").trim() : ""),
          x   : (idx.x  >-1 ? (r[idx.x]  ||"").trim() : ""),
        });
      }
    }
  }

  if (!data.length){
    // ===== フォールバック：01.png〜NN.png を並べる =====
    data = Array.from({length:FALLBACK_COUNT}, (_,i)=>({
      name: String(i+1).padStart(2,"0")+".png",
      icon: `assets/icons/${String(i+1).padStart(2,"0")}.png`,
      work: "#", feel:"#", x:"#"
    }));
  }

  render(data);
})();

/* ---------- helpers ---------- */
function tell(msg){
  elErr.style.display="block";
  elErr.textContent = msg;
}
function pickIndex(hdr, keys){
  const flat = hdr.map(h=>h.toLowerCase());
  for(const k of keys){
    const i = flat.indexOf(k.toLowerCase());
    if(i>-1) return i;
  }
  // startsWith/含む でも救済
  for(const k of keys){
    const i = flat.findIndex(h => h.includes(k.toLowerCase()));
    if(i>-1) return i;
  }
  return -1;
}
function fixIcon(s){
  // すでに http(s) ならそのまま。そうでなければ assets/icons/ を前置
  if(!s) return s;
  if(/^https?:\/\//i.test(s)) return s;
  // パスだけ or ファイル名だけに対応
  const file = s.split(/[/\\]/).pop();
  return `assets/icons/${file}`;
}
function parseCSV(text){
  // 素直なCSVパーサ（ダブルクオート対応）
  const lines = [];
  let i=0, field="", row=[], q=false;
  const pushField = ()=>{ row.push(field); field=""; };
  const pushRow   = ()=>{ lines.push(row); row=[]; };
  while(i<text.length){
    const c=text[i++];
    if(q){
      if(c=='"'){
        if(text[i]=='"'){ field+='"'; i++; }
        else q=false;
      }else field+=c;
    }else{
      if(c=='"') q=true;
      else if(c==',') pushField();
      else if(c=='\n'){ pushField(); pushRow(); }
      else if(c=='\r'){ /* ignore */ }
      else field+=c;
    }
  }
  // last
  pushField(); if(row.length) pushRow();
  // 末尾の空行除去
  return lines.filter(r=>r.some(x=>x!==""));
}

function render(data){
  const frag=document.createDocumentFragment();
  data.forEach(d=>{
    const card = document.createElement("article");
    card.className="card";

    const stack = document.createElement("div");
    stack.className="stack";

    const img = document.createElement("img");
    img.className="icon"; img.alt=""; img.decoding="async";
    img.src = d.icon;

    // アイコンはリンクなし（スマホでの誤タップ回避）。Hoverで影＆ボタンは見える
    stack.appendChild(img);

    const actions = document.createElement("div");
    actions.className="actions";

    const aWork = document.createElement("a");
    aWork.className="pill"; aWork.textContent="作品";
    if(d.work) aWork.href=d.work; else aWork.href="#";
    aWork.target="_blank"; aWork.rel="noopener";

    const aFeel = document.createElement("a");
    aFeel.className="pill"; aFeel.textContent="感想";
    if(d.feel) aFeel.href=d.feel; else aFeel.href="#";
    aFeel.target="_blank"; aFeel.rel="noopener";

    actions.append(aWork, aFeel);
    stack.appendChild(actions);

    const aName = document.createElement("a");
    aName.className="name";
    aName.textContent = d.name || "";
    if(d.x){ aName.href=d.x; aName.target="_blank"; aName.rel="noopener"; }

    card.append(stack, aName);
    frag.appendChild(card);
  });
  elG.replaceChildren(frag);
}
</script>
</body>
</html>
