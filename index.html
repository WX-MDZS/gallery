<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>作品一覧</title>

<style>
/* ここだけ差分：グリッド4列固定 */
.gallery{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:26px 22px;
  justify-items:center;
}
</style>

<script>
const CSV_URL = "（あなたのGoogleスプレッドシートCSVのURL）";

async function loadCSV(url){
  try{
    const res = await fetch(url, {cache:"no-store"});
    if(!res.ok) throw new Error(res.status);
    const text = await res.text();
    return text.split(/\r?\n/).map(r=>r.split(",")).slice(1);
  }catch(err){
    console.error("CSV取得失敗:", err);
    return null;
  }
}

(async function init(){
  const gallery = document.getElementById("gallery");
  gallery.textContent = "";
  let rows = await loadCSV(CSV_URL);

  if(!rows){
    // 仮データ 4列×6行
    rows = Array.from({length:24},(_,i)=>[
      "sample","No."+String(i+1),"#","",""
    ]);
  }

  rows.forEach(r=>gallery.appendChild(createCard(r)));
})();
</script>

</head>
<body>

  <div class="header">
    <h1>作品一覧</h1>
    <p class="lead">アイコン＝X、ポップアップのボタン＝作品・感想</p>
    <p class="counter">あなたは「<span id="count" class="digits">000000</span>」人目の姑蘇藍氏の弟子</p>
  </div>

  <div class="wrap">
    <div id="gallery" class="gallery" aria-live="polite"></div>
    <p class="footer">雲隠深情企画 / 主催はくと</p>
  </div>

<script>
/* ========= 設定 ========= */
const CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQLr1090BcgO8C08pdp3UHuN73zUFB68OyW47BSihAvvVxbwDtMBwK0st9tJpg8nqpNTR0m4QHjcVs4/pub?gid=0&single=true&output=csv";

/* 訪問カウンター（ローカル） */
(function(){
  try{
    const KEY="yd_gallery_counter_v1";
    let n = Number(localStorage.getItem(KEY) || "0");
    n += 1;
    localStorage.setItem(KEY, String(n));
    document.getElementById("count").textContent = String(n).padStart(6,"0");
  }catch(_) {}
})();

/* CSVを素朴に読む（カンマ/改行対応） */
async function loadCSV(url){
  const res = await fetch(url, {cache:"no-store"});
  const text = await res.text();
  const rows=[]; let i=0, cur="", inQ=false, row=[];
  while(i<text.length){
    const c=text[i++];
    if(c==='"'){ inQ=!inQ; continue; }
    if(!inQ && (c===',' || c==='\n' || c==='\r')){
      row.push(cur); cur="";
      if(c!==' , ' && (c==='\n' || c==='\r')){ if(row.length) rows.push(row); row=[]; }
    }else{ cur+=c; }
  }
  if(cur.length || row.length){ row.push(cur); rows.push(row); }
  return rows.filter(r=>r.length>=3).slice(1); // 1行目ヘッダを除外
}

/* 1カード生成：A=アイコン名, B=名前, C=Twitter, D=作品, E=感想 */
function createCard([iconName, displayName, twitter, work, feedback]){
  const card = document.createElement("div");
  card.className = "card";

  const wrap = document.createElement("div");
  wrap.className = "icon-wrap";

  // アイコン=Twitterへ
  const tw = document.createElement("a");
  tw.href = (twitter || "#").trim();
  tw.target = "_blank"; tw.rel = "noopener";

  const img = document.createElement("img");
  const file = (iconName || "").trim().replace(/\.(png|jpg|jpeg|webp)$/i,"");
  img.src = "./icons/" + file + ".png";
  img.alt = displayName || "";
  img.className = "icon";

  tw.appendChild(img);
  wrap.appendChild(tw);
  card.appendChild(wrap);

  const name = document.createElement("div");
  name.className = "name";
  name.textContent = (displayName || "").trim();
  card.appendChild(name);

  // ポップアップ
  const pop = document.createElement("div");
  pop.className = "pop";

  const toWork = document.createElement("a");
  toWork.className = "pill";
  toWork.textContent = "作品へ";
  toWork.href = (work || "#").trim();
  toWork.target = "_blank"; toWork.rel = "noopener";

  const toFb = document.createElement("a");
  toFb.className = "pill";
  toFb.textContent = "感想へ";
  toFb.href = (feedback || "#").trim();
  toFb.target = "_blank"; toFb.rel = "noopener";

  pop.appendChild(toWork); pop.appendChild(toFb);
  card.appendChild(pop);

  // タッチで開閉（1回目は開く）
  card.addEventListener("touchstart", e=>{
    if(!card.classList.contains("pop-open")){
      card.classList.add("pop-open");
      setTimeout(()=>card.classList.remove("pop-open"), 2500);
    }
  }, {passive:true});

  // ESCで閉じる
  card.addEventListener("keydown", e=>{
    if(e.key==="Escape") card.classList.remove("pop-open");
  });

  return card;
}

/* 初期化 */
(async function init(){
  const gallery = document.getElementById("gallery");
  gallery.textContent = "";
  try{
    const rows = await loadCSV(CSV_URL);
    rows.forEach(r => gallery.appendChild(createCard(r)));
  }catch(err){
    console.error(err);
    gallery.textContent = "データの読み込みに失敗しました。";
  }
})();
</script>
</body>
</html>

