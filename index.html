<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>雲隠深情 | 作品一覧</title>
<style>
  :root{
    --accent: rgb(103,167,186);        /* R103 G167 B186 */
    --shadow: 0 10px 24px rgba(0,0,0,.08);
    --shadow-hover: 0 18px 36px rgba(0,0,0,.14);
    --icon-size: 120px;
    --card-w: 240px;
  }

  *{ box-sizing: border-box; }
  html,body{ margin:0; padding:0; background:#fff; color:#222; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; }

  header{ padding: 28px 8px 0; text-align:center; }
  header img{ max-width:min(920px,90vw); height:auto; display:block; margin:0 auto; }

  main{ width:min(1100px, 94vw); margin: 0 auto 64px; }

  /* 見出したち */
  .lead { text-align:center; color:#555; margin: 4px 0 6px; }
  .counter { text-align:center; margin: 10px 0 24px; }
  .counter strong{ 
    display:inline-block;
    font-weight:700;
    font-size: clamp(20px, 3.2vw, 28px);    /* ← 大きめ：先輩の行 */
  }

  h1{                          /* 作品一覧（少し小さめ） */
    text-align:center;
    font-size: clamp(20px, 2.4vw, 24px);
    margin: 8px 0 6px;
  }

  /* グリッド */
  .gallery{
    display:grid;
    grid-template-columns: repeat(auto-fill, minmax(var(--card-w), 1fr));
    gap: 24px;
    place-items:center;
  }

  /* カード */
  .card{
    width: var(--card-w);
    background:#fff;
    border-radius: 14px;
    box-shadow: var(--shadow);
    padding: 18px 12px 16px;
    text-align:center;
    transition: transform .15s ease, box-shadow .15s ease;
  }
  .card:hover{
    transform: translateY(-2px);
    box-shadow: var(--shadow-hover);
  }

  .icon-wrap{
    position: relative;
    display: inline-block;
    padding-bottom: 54px;        /* ← ボタン分のスペースを確保（名前と被らない） */
  }

  .icon{
    width: var(--icon-size);
    height: var(--icon-size);
    border-radius: 50%;
    object-fit: cover;
    display:block;
    margin: 0 auto;
    border: 4px solid #d7ecf3;
    box-shadow: 0 4px 12px rgba(0,0,0,.08);
    transition: box-shadow .15s ease, transform .15s ease, filter .15s ease;
  }
  .card:hover .icon{
    box-shadow: 0 10px 26px rgba(0,0,0,.16);
    transform: translateY(-1px);
    filter: saturate(1.04);
  }

  /* 作品/感想のポップ（横並び） */
  .pop{
    position:absolute;
    left:50%;
    top: calc(var(--icon-size) + 10px);
    transform: translateX(-50%);
    display:flex;
    gap:.6rem;
    pointer-events: none;  /* ボタン以外での誤タップ抑制 */
  }
  .pill{
    pointer-events: auto;
    display:inline-block;
    font-size:.9rem;
    padding:.45rem .85rem;
    border-radius: 999px;
    border:1px solid var(--accent);
    color: var(--accent);
    text-decoration:none;
    background:#f8fafc;
    transition: background .12s, border-color .12s, color .12s;
    box-shadow: 0 2px 8px rgba(0,0,0,.06);
  }
  .pill:hover{
    background: rgba(103,167,186,.15);
    border-color: var(--accent);
    color: var(--accent);
  }

  /* 名前（Xリンク。黒のまま） */
  .name{
    margin-top: 8px;             /* ボタンとの余白 */
    font-weight:700;
    line-height:1.15;
  }
  .name a{
    color:#111;
    text-decoration:none;
  }
  .name a:hover{
    text-decoration: underline;
  }

  footer{
    text-align:center;
    color:#666;
    font-size:.9rem;
    margin: 44px 0 32px;
  }

  /* CSV メッセージ（見出し不一致時のみ出る） */
  .notice{
    background:#fff9e6;
    border:1px solid #f2e2b6;
    color:#7a5a00;
    padding:12px 14px;
    border-radius:12px;
    width:min(1000px, 92vw);
    margin: 14px auto 22px;
    display:none;                 /* 既定は非表示。必要時に JS で表示 */
  }

  @media (max-width: 560px){
    :root{ --icon-size: 104px; --card-w: 200px; }
    .icon-wrap{ padding-bottom: 52px; }
  }
</style>
</head>
<body>

<header>
  <img src="assets/title.jpg" alt="雲隠深情">
</header>

<main>
  <p class="counter"><strong>あなたは「<span id="visitor">000000</span>」人目の姑蘇藍氏の先輩</strong></p>
  <p class="lead">アイコン＝Twitter、ポップアップのボタン＝作品・感想</p>
  <h1>作品一覧</h1>

  <div id="csvNotice" class="notice"></div>

  <section id="gallery" class="gallery" aria-live="polite"></section>
</main>

<footer>雲隠探情企画 / 主催はくと</footer>

<script>
/* ========= ここだけあなたのシートに合わせてください =========
   見出し（1行目）は必ず：
   アイコン, 名前, ツイッター, 作品, 感想
   の5列でお願いします。                                        */
const CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQLr1090BcgO8C08pdp3UHuN73zUFB68OyW47BSihAvvVxbwDtMBwK0st9tJpg8nqpNTR0m4QHjcVs4/pub?gid=0&single=true&output=csv";
/* ============================================================ */

const EXPECTED_HEADERS = ["アイコン","名前","ツイッター","作品","感想"];

const $gallery = document.getElementById("gallery");
const $notice  = document.getElementById("csvNotice");

/* 訪問者カウンター（6桁） */
(function(){
  const key = "visitor-count";
  let n = +(localStorage.getItem(key) || 0);
  n++;
  localStorage.setItem(key, n);
  document.getElementById("visitor").textContent = String(n).padStart(6,"0");
})();

/* CSV を取ってレンダリング */
(async function init(){
  try{
    const res = await fetch(CSV_URL + "&_ts=" + Date.now());
    if(!res.ok) throw new Error("CSV fetch failed");
    const text = await res.text();

    const rows = parseCSV(text);
    if(rows.length === 0) throw new Error("CSV empty");

    // 見出し判定
    let header = rows[0].map(s=>s.trim().replace(/^\uFEFF/, "")); // BOM除去
    let dataRows = rows.slice(1);

    let idx = {icon:0, name:1, tw:2, work:3, feel:4};
    let headerOK = EXPECTED_HEADERS.every((h,i)=> header[i] === h);

    // 見出し不一致なら推測（アイコン/名前/ツイッター/作品/感想）
    if(!headerOK){
      // 位置推測（日本語見出しが入っていない時も列順で対応）
      const mapByText = (want) => header.findIndex(h => h === want);
      const tryIdx = {
        icon: mapByText("アイコン"),
        name: mapByText("名前"),
        tw  : mapByText("ツイッター"),
        work: mapByText("作品"),
        feel: mapByText("感想"),
      };
      // いずれか欠けたら列順の既定
      if(Object.values(tryIdx).some(v=>v<0)){
        idx = {icon:0, name:1, tw:2, work:3, feel:4};
      }else{
        idx = tryIdx;
      }
      // お知らせ表示
      $notice.style.display = "block";
      $notice.textContent =
        "CSVの見出しが判定できなかったため、列の並び（アイコン/名前/ツイッター/作品/感想）で推測して読み込みました。見出しを付け直すとより安全です。";
    }

    // 描画
    const frag = document.createDocumentFragment();
    for(const r of dataRows){
      // 空行スキップ（アイコンも名前も空）
      if(!r[idx.icon] && !r[idx.name]) continue;

      const icon  = (r[idx.icon] || "").trim();
      const name  = (r[idx.name] || "").trim();
      const tw    = (r[idx.tw]   || "").trim();
      const work  = (r[idx.work] || "").trim();
      const feel  = (r[idx.feel] || "").trim();

      frag.appendChild(makeCard({icon, name, tw, work, feel}));
    }
    $gallery.innerHTML = "";
    $gallery.appendChild(frag);

  }catch(err){
    console.error(err);
    $notice.style.display = "block";
    $notice.textContent = "CSVの読み込みに失敗しました。URLと公開設定をご確認ください。";
  }
})();

/* カードDOM */
function makeCard({icon, name, tw, work, feel}){
  const card = document.createElement("article");
  card.className = "card";

  // 画像パス（http で始まらなければ /icons/ を見る）
  let src = icon;
  if(src && !/^https?:\/\//i.test(src)) src = `icons/${src}`;

  const wrap = document.createElement("div");
  wrap.className = "icon-wrap";

  const img = document.createElement("img");
  img.className = "icon";
  img.alt = `${name || "アイコン"}`;
  img.src = src || "";
  wrap.appendChild(img);

  // 作品・感想（横並び）
  const pop = document.createElement("div");
  pop.className = "pop";
  const toWork = document.createElement("a");
  toWork.className = "pill";
  toWork.textContent = "作品";
  toWork.href = work || "#";
  toWork.target = "_blank";
  toWork.rel = "noopener";

  const toFeel = document.createElement("a");
  toFeel.className = "pill";
  toFeel.textContent = "感想";
  toFeel.href = feel || "#";
  toFeel.target = "_blank";
  toFeel.rel = "noopener";

  pop.appendChild(toWork);
  pop.appendChild(toFeel);
  wrap.appendChild(pop);

  // 名前（Xへ。黒文字のまま）
  const nm = document.createElement("div");
  nm.className = "name";
  const a = document.createElement("a");
  a.href = tw || "#";
  a.target = "_blank";
  a.rel = "noopener";
  a.textContent = name || "(無題)";
  nm.appendChild(a);

  card.appendChild(wrap);
  card.appendChild(nm);
  return card;
}

/* 超簡易CSVパーサ（カンマ+ダブルクオート対応） */
function parseCSV(text){
  const rows = [];
  let i=0, field="", row=[], inQ=false;

  const pushField = ()=>{ row.push(field); field=""; };
  const pushRow = ()=>{ rows.push(row); row=[]; };

  while(i < text.length){
    const c = text[i];

    if(inQ){
      if(c === '"'){
        if(text[i+1] === '"'){ field+='"'; i+=2; continue; }
        inQ = false; i++; continue;
      }else{ field += c; i++; continue; }
    }else{
      if(c === '"'){ inQ = true; i++; continue; }
      if(c === ','){ pushField(); i++; continue; }
      if(c === '\r'){ i++; continue; }       // ignore
      if(c === '\n'){ pushField(); pushRow(); i++; continue; }
      field += c; i++; continue;
    }
  }
  // last
  pushField();
  pushRow();
  // 末尾の空行除去
  return rows.filter(r => !(r.length===1 && r[0]===""));
}
</script>
</body>
</html>
