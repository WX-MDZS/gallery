<script>
const CSV_URL = "（あなたの公開CSVのURL）";

// 余白・全角空白を除去して小文字に
const norm = s => (s||"").toString().replace(/\s+/g,"").replace(/\u3000/g,"").toLowerCase();

const HEADER_ALIASES = {
  name:     ["名前","name"],
  icon:     ["アイコン","icon","画像"],
  x:        ["x","twitter","ツイッター"],
  work:     ["作品","作品url"],
  feedback: ["感想","感想フォーム","feedback","form"]
};

function findIndex(headerRow, keys){
  const H = headerRow.map(norm);
  for(const k of keys.map(norm)){
    const i = H.indexOf(k);
    if(i !== -1) return i;
  }
  return -1;
}

async function loadCSV(url){
  const res = await fetch(url, {cache:"no-store"});
  const text = await res.text();

  // シンプルCSVパーサ（カンマと改行）
  const rows = text.replace(/\r/g,"").split("\n").filter(r=>r.trim()!=="")
                   .map(r => r.split(",").map(c => c.replace(/^"|"$/g,"")));

  if(rows.length < 2){
    throw new Error("CSVにデータ行がありません。");
  }

  const header = rows[0];
  const idx = {
    name:     findIndex(header, HEADER_ALIASES.name),
    icon:     findIndex(header, HEADER_ALIASES.icon),
    x:        findIndex(header, HEADER_ALIASES.x),
    work:     findIndex(header, HEADER_ALIASES.work),
    feedback: findIndex(header, HEADER_ALIASES.feedback)
  };

  // どれか見つからない場合は不足見出しを表示
  const missing = Object.entries(idx).filter(([,v]) => v === -1).map(([k])=>k);
  if(missing.length){
    const need = "名前 / アイコン / 作品 / 感想 / X のいずれか";
    throw new Error(`CSVの見出しが見つかりません: ${missing.join(", ")}。許容される見出し例: ${need}`);
  }

  // データ整形
  const data = rows.slice(1)
                  .filter(r => r.some(c => String(c).trim() !== "")) // 空行除外
                  .map(r => ({
                    name: r[idx.name]?.trim(),
                    icon: r[idx.icon]?.trim(),
                    x:    r[idx.x]?.trim(),
                    work: r[idx.work]?.trim(),
                    fb:   r[idx.feedback]?.trim()
                  }));
  return data;
}

// ここから先は data を使ってカードを描画（あなたの既存描画ロジック）
// 例：loadCSV(CSV_URL).then(render).catch(showError);
</script>
