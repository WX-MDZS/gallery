<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>雲隠深情 | 作品一覧</title>
<style>
  :root{
    --ring:#67A7BA;         /* ボーダー/リンク色 R103 G167 B186 */
    --text:#222;
    --muted:#666;
    --pill-bg:#f8fafc;
    --shadow:0 12px 28px rgba(0,0,0,.08);
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
    color:var(--text);
    background:#fff;
    -webkit-tap-highlight-color:transparent;
  }

  header{ text-align:center; padding:24px 12px 8px }
  header img{ width:min(920px,88vw); height:auto; display:block; margin:0 auto }

  h2{ text-align:center; margin:.25rem 0 0; }
  p.lead{ text-align:center; color:var(--muted); margin:.5rem 0 1rem; font-size:.95rem }
  .counter{ text-align:center; margin:.75rem 0 1.25rem; font-weight:700 }
  .counter span{ font-variant-numeric:tabular-nums; letter-spacing:.05em }

  /* ====== グリッド（PC4列 / SP2列） ====== */
  .wrap{ display:flex; justify-content:center }
  .gallery{
    display:grid;
    grid-template-columns:repeat(4, 240px);
    gap:22px;
    padding:8px 16px 48px;
    width:fit-content;
  }
  @media (max-width: 720px){
    .gallery{ grid-template-columns:repeat(2, 240px); gap:18px }
  }

  /* ====== カード ====== */
  .card{
    width:240px; height:240px; /* 正方形、固定 */
    background:#fff;
    border-radius:18px;
    box-shadow:0 2px 10px rgba(0,0,0,.05);
    display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
    position:relative; text-align:center;
    padding-top:22px;   /* アイコンの上余白 */
    overflow:hidden;    /* ポップアップの丸角に沿う */
  }
  .icon-wrap{ position:relative; width:120px; height:120px; margin:0 auto }
  .icon{
    width:120px; height:120px; border-radius:50%;
    object-fit:cover; background:#f3f4f6; display:block;
    border:4px solid #e6f2f6; outline:2px solid var(--ring);
    filter:drop-shadow(0 10px 20px rgba(0,0,0,.07));
    transition:transform .18s, filter .18s;
  }
  .card:hover .icon,
  .card:focus-within .icon{ transform:scale(1.04); filter:saturate(1.03) drop-shadow(0 12px 26px rgba(0,0,0,.1)) }

  /* ====== ポップアップ（アイコン上に重ねる） ====== */
  .pop{
    position:absolute;
    left:50%;
    bottom:-8px;                   /* ★ 下にはみ出させて”重ねる” */
    transform:translateX(-50%);
    display:flex; gap:.6rem;
    background:#fff;
    padding:.4rem .5rem;
    border-radius:12px;
    box-shadow: var(--shadow);
    border:1px solid var(--ring);
    z-index:5;
    opacity:0; pointer-events:none; transition:opacity .15s;
  }
  .card:hover .pop,
  .card.card-open .pop{ opacity:1; pointer-events:auto }

  .pill{
    display:inline-block; min-width:64px;
    padding:.35rem .6rem; font-size:.9rem; line-height:1;
    border-radius:999px;
    text-decoration:none;
    color:var(--ring); background:var(--pill-bg);
    border:1px solid var(--ring);
    transition:background .12s, transform .12s;
  }
  .pill:active{ transform:translateY(1px) }
  .pill:hover{ background:rgba(103,167,186,.15) }

  /* ====== 名前（Twitter リンク） ====== */
  .name{
    margin-top:38px;              /* ★ポップアップの分だけ下げる */
    font-weight:700; text-decoration:none; color:var(--text);
  }

  /* 余白の微調整（モバイル） */
  @media (max-width:420px){
    .card{ width:236px; height:236px }
  }

  /* カード全体をキーボード操作しやすく */
  .card:focus-within{ outline:3px solid rgba(103,167,186,.25) }
</style>
</head>
<body>
  <header>
    <img src="assets/title.jpg" alt="雲隠深情">
  </header>

  <h2>作品一覧</h2>
  <p class="lead">アイコン＝Twitter、ポップアップのボタン＝作品・感想</p>
  <p class="counter">あなたは<span id="visitor">000000</span>人目の姑蘇藍氏の先輩</p>

  <div class="wrap">
    <div id="gallery" class="gallery" aria-live="polite"></div>
  </div>

  <footer style="text-align:center;color:#666;margin:24px 0 48px">雲隠探情企画 / 主催はくと</footer>

<script>
/* ===================== ユーティリティ ===================== */
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQLr1090BcgO8C08pdp3UHuN73zUFB68OyW47BSihAvvVxbwDtMBwK0st9tJpg8nqpNTR0m4QHjcVs4/pub?gid=0&single=true&output=csv";

/* 訪問カウンタ（6桁） */
{
  const k="visitCount";
  let n=Number(localStorage.getItem(k)||0)+1;
  localStorage.setItem(k,n);
  document.getElementById("visitor").textContent=String(n).padStart(6,"0");
}

/* CSV → 配列 */
async function loadCSV(url){
  const res = await fetch(url, {cache:"no-store"});
  const text = await res.text();
  const rows = text.split(/\r?\n/).map(r=>r.trim());
  const out = [];
  for(const r of rows){
    if(!r) continue;
    // A:アイコン名, B:表示名, C:X, D:作品, E:感想
    const cols = r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(s=>s.replace(/^"|"$/g,""));
    out.push({icon: cols[0], name: cols[1], x: cols[2], work: cols[3], fb: cols[4]});
  }
  // 先頭行が見出しなら取り除く（EastBud 行を消さない）
  if(out.length && /アイコン|Icon/i.test(out[0].icon)) out.shift();
  return out.filter(r=>r.icon || r.name);
}

/* カード生成 */
function makeCard(row){
  const card = document.createElement("article");
  card.className = "card";

  // アイコン（リンクなし：ホバーで影、タップでポップ開閉）
  const wrap = document.createElement("div");
  wrap.className = "icon-wrap";
  const img = document.createElement("img");
  img.className = "icon";
  img.alt = row.name || "";
  img.src = `icons/${row.icon}.png`;     // 01〜32.png を想定
  wrap.appendChild(img);

  // ポップアップ（★アイコン上に重ねる）
  const pop = document.createElement("div");
  pop.className = "pop";
  const aWork = document.createElement("a");
  aWork.className = "pill"; aWork.textContent = "作品";
  aWork.href = row.work || "#"; aWork.target="_blank"; aWork.rel="noopener";
  const aFb = document.createElement("a");
  aFb.className = "pill"; aFb.textContent = "感想";
  aFb.href = row.fb || "#"; aFb.target="_blank"; aFb.rel="noopener";
  pop.append(aWork, aFb);
  wrap.appendChild(pop);

  // 名前（Twitter へ）
  const name = document.createElement("a");
  name.className = "name";
  name.textContent = row.name || "";
  if(row.x){ name.href = row.x; name.target="_blank"; name.rel="noopener"; }
  else { name.href="#"; name.addEventListener("click", e=>e.preventDefault()); }

  card.append(wrap, name);

  // タップで開閉（1回タップ＝開く、他所タップ＝閉じる）
  card.addEventListener("touchstart", e=>{
    if(!card.classList.contains("card-open")){
      card.classList.add("card-open");
      // その場の 1 回だけ、画面の他所タップで閉じる
      const closeOnce = ev=>{
        if(!card.contains(ev.target)){
          card.classList.remove("card-open");
          window.removeEventListener("touchstart", closeOnce);
        }
      };
      window.addEventListener("touchstart", closeOnce);
    }
  }, {passive:true});

  // Esc で閉じる
  card.addEventListener("keydown", e=>{
    if(e.key === "Escape") card.classList.remove("card-open");
  });

  return card;
}

/* 初期化 */
(async function init(){
  const list = await loadCSV(CSV_URL);
  const box = document.getElementById("gallery");
  box.innerHTML = "";
  list.forEach(row=> box.appendChild(makeCard(row)));
})();
</script>
</body>
</html>
