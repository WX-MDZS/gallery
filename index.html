<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>雲隠深情 | 作品一覧</title>

<style>
:root{
  --pill: rgb(103,167,186); /* ボタン色＆リンク色 */
  --ring: rgba(103,167,186,.35);
  --shadow: 0 8px 26px rgba(0,0,0,.08);
  --shadow-strong: 0 10px 24px rgba(0,0,0,.15);
}

*{ box-sizing:border-box }
html,body{ margin:0; padding:0; background:#fff; color:#111; font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN","Yu Gothic", "Noto Sans JP", sans-serif; }

/* === 背景（下側固定） === */
body::after{
  content:"";
  position:fixed;
  left:0; right:0; bottom:0;
  height:min(40vh,520px);
  background:url("./assets/haikei.jpg") center bottom / cover no-repeat;
  pointer-events:none;
  z-index:-1;
  opacity:.9;
}

/* ページ幅 */
.container{ max-width:1060px; margin:0 auto; padding:20px 16px 80px; }

/* ヘッダ */
header{ text-align:center; margin:10px 0 8px; }
header img{ width:min(680px, 86vw); height:auto; display:block; margin:0 auto; }

h1{ text-align:center; margin:16px 0 6px; font-size:clamp(22px,3.5vw,30px); }
.sub{ text-align:center; color:#666; font-size:.95rem; margin:0 0 10px; }
.counter{ text-align:center; font-weight:700; margin:8px 0 24px; }
.counter .num{ font-variant-numeric:tabular-nums; letter-spacing:.04em; }

/* グリッド（PC=4列 / スマホ=2列） */
.gallery{
  display:grid;
  grid-template-columns:repeat(4, 1fr);
  gap:24px;
  justify-items:center;
}
@media (max-width:700px){
  .gallery{ grid-template-columns:repeat(2, 1fr); gap:18px; }
}

/* カード：ほぼ正方形 & 固定サイズ寄り（幅で崩れにくい） */
.card{
  width:220px;           /* できる限り正方形で最小限サイズ */
  height:230px;
  background:#fff;
  border-radius:16px;
  box-shadow:var(--shadow);
  padding:16px 10px 12px;
  position:relative;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
}
@media (max-width:700px){
  .card{ width:170px; height:190px; }
}

/* アイコン（丸+枠+ホバー影） */
.icon-wrap{ position:relative; display:inline-block; }
.icon{
  width:120px; height:120px;
  border-radius:50%;
  object-fit:cover;
  border:3px solid var(--ring);
  box-shadow:0 2px 8px rgba(0,0,0,.05);
  transition: box-shadow .25s ease, transform .12s ease;
}
.icon:hover{
  box-shadow: var(--shadow-strong);
}

/* ポップ（「作品」「感想」）— アイコンの真下、中央に横並びで表示 */
.pop{
  position:absolute;
  left:50%;
  top: calc(100% + 8px);           /* アイコンの少し下（名前の少し上） */
  transform: translateX(-50%);
  display:flex;
  gap:12px;
  padding:6px 8px;
  pointer-events:none;             /* 初期は触れない（ホバー時だけ解放） */
  opacity:0;
  transition:opacity .15s ease, transform .15s ease;
}
.icon-wrap:hover .pop,
.card:focus-within .pop{
  opacity:1;
  pointer-events:auto;
  transform: translateX(-50%) translateY(-2px);
  z-index:20;
}

/* 丸ピルボタン */
.pill{
  display:inline-block;
  font-size:.95rem;
  line-height:1;
  padding:.48rem .75rem;
  border-radius:999px;
  text-decoration:none;
  color:var(--pill);
  border:1px solid var(--pill);
  background:#fff;
  box-shadow:0 2px 8px rgba(0,0,0,.08);
  transition: background .12s, color .12s, border-color .12s, transform .05s;
}
.pill:hover{ background:rgba(103,167,186,.12); }
.pill:active{ transform:translateY(1px); }

/* 名前（Xへのリンク）— 黒のまま */
.name{
  margin-top:52px;        /* アイコンとポップ分の余白 */
  font-weight:700;
  font-size:1.02rem;
}
.name a{ color:#111; text-decoration:none; }
.name a:hover{ text-decoration:underline; }

/* フッタ */
footer{ text-align:center; color:#666; margin:42px 0 8px; font-size:.95rem; }
</style>
</head>

<body>
  <div class="container">
    <header>
      <img src="./assets/title.jpg" alt="雲隠深情" />
    </header>

    <h1>作品一覧</h1>
    <p class="sub">アイコン=Twitter、ポップアップのボタン=作品・感想</p>
    <p class="counter">あなたは「<span id="vc" class="num">000000</span>」人目の姑蘇藍氏の弟子</p>

    <div id="gallery" class="gallery" aria-live="polite"></div>

    <footer>雲隠探情企画 / 主催はくと</footer>
  </div>

<script>
/* ====== 設定 ====== */
// スプレッドシート公開CSV（更新すると自動で反映されます）
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQLr1090BcgO8C08pdp3UHuN73zUFB68OyW47BSihAvvVxbwDtMBwK0st9tJpg8nqpNTR0m4QHjcVs4/pub?gid=0&single=true&output=csv";

// アイコンパス補完（CSVがファイル名だけのとき）
function resolveIcon(src){
  if(!src) return "";
  if(/^https?:\/\//.test(src)) return src;
  // 先頭/が無ければ assets/icons/ を付ける
  return `./assets/icons/${src}`;
}

/* ====== 訪問カウンタ ====== */
(function(){
  try{
    const el = document.getElementById("vc");
    let n = Number(localStorage.getItem("visitCount")||"0") + 1;
    localStorage.setItem("visitCount", String(n));
    el.textContent = String(n).padStart(6,"0");
  }catch(e){}
})();

/* ====== CSV 読み込み → カード描画 ====== */
async function loadCSV(url){
  const res = await fetch(url,{cache:"no-store"});
  if(!res.ok) throw new Error("CSV fetch failed");
  const text = await res.text();
  return parseCSV(text);
}

// ちょい強めのCSVパーサ（カンマ含むセルも対応）
function parseCSV(text){
  const rows = [];
  let row = [], cell = "", inQ = false;
  for(let i=0;i<text.length;i++){
    const c = text[i], n = text[i+1];
    if(inQ){
      if(c === '"' && n === '"'){ cell += '"'; i++; continue; }
      if(c === '"'){ inQ = false; continue; }
      cell += c;
    }else{
      if(c === '"'){ inQ = true; continue; }
      if(c === ","){ row.push(cell); cell=""; continue; }
      if(c === "\n"){
        row.push(cell); rows.push(row); row=[]; cell=""; continue;
      }
      if(c === "\r"){ continue; }
      cell += c;
    }
  }
  if(cell.length || row.length) { row.push(cell); rows.push(row); }
  return rows;
}

function toData(rows){
  // 最初の行をヘッダとして利用。空行は除外。
  const header = rows[0].map(h=>h.trim());
  const list = [];
  for(let i=1;i<rows.length;i++){
    const r = rows[i];
    if(!r || r.every(v => !String(v||"").trim())) continue;
    const o = {};
    header.forEach((h,idx)=> o[h] = (r[idx]||"").trim());
    // 想定ヘッダ例: name, icon, x, work, review
    if(!o.name) continue;
    list.push({
      name: o.name,
      icon: resolveIcon(o.icon || o.icon_path || o.img || ""),
      x:     o.x || o.twitter || o.link || "",
      work:  o.work || o.art || "",
      review:o.review || o.impression || ""
    });
  }
  return list;
}

function cardDOM({name,icon,x,work,review}){
  // スマホ：アイコンはリンク無し（影のみ）、名前クリックでXへ
  const wrap = document.createElement("div");
  wrap.className = "card";

  const iconWrap = document.createElement("div");
  iconWrap.className = "icon-wrap";

  const img = document.createElement("img");
  img.className = "icon";
  img.alt = name;
  img.loading = "lazy";
  img.decoding = "async";
  img.src = icon || ""; // 404なら自然に壊れるだけ

  // ポップ（作品・感想）
  const pop = document.createElement("div");
  pop.className = "pop";

  if(work){
    const a = document.createElement("a");
    a.className = "pill";
    a.target = "_blank";
    a.rel = "noopener";
    a.href = work;
    a.textContent = "作品";
    pop.appendChild(a);
  }
  if(review){
    const a = document.createElement("a");
    a.className = "pill";
    a.target = "_blank";
    a.rel = "noopener";
    a.href = review;
    a.textContent = "感想";
    pop.appendChild(a);
  }

  iconWrap.appendChild(img);
  iconWrap.appendChild(pop);
  wrap.appendChild(iconWrap);

  // 名前（Xへ）— 黒リンク
  const nameEl = document.createElement("div");
  nameEl.className = "name";
  if(x){
    const a = document.createElement("a");
    a.href = x;
    a.target = "_blank";
    a.rel = "noopener";
    a.textContent = name;
    nameEl.appendChild(a);
  }else{
    nameEl.textContent = name;
  }
  wrap.appendChild(nameEl);

  return wrap;
}

(async function init(){
  const root = document.getElementById("gallery");
  root.innerHTML = "読み込み中…";

  try{
    const rows = await loadCSV(CSV_URL);
    const data = toData(rows);

    // 念のためソート安定（CSV順のまま）
    const frag = document.createDocumentFragment();
    data.forEach(d => frag.appendChild(cardDOM(d)));

    root.innerHTML = "";
    root.appendChild(frag);
  }catch(e){
    console.error(e);
    root.textContent = "データの読み込みに失敗しました。時間をおいて再読み込みしてください。";
  }
})();
</script>
</body>
</html>
