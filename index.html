<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>雲隠深情 | 作品一覧</title>
<style>
:root{
  /* 色とサイズ */
  --accent: rgb(103,167,186);
  --shadow: 0 10px 24px rgba(0,0,0,.08);
  --shadow-hover: 0 18px 36px rgba(0,0,0,.14);

  /* カード/アイコンの基準値（PC） */
  --card-w: 220px;
  --icon-size: 116px;

  /* グリッドの間隔（行は少し広め＝ポップアップ分） */
  --gap-x: 16px;
  --gap-y: 26px;
}

/* ========== base ========== */
*{box-sizing:border-box}
html,body{
  background:#fff; color:#222;
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN","Hiragino Sans",Meiryo,sans-serif
}
body{margin:0; padding:0 0 56px; text-align:center}

/* header */
header{padding:22px 10px 8px}
header img{width:min(880px,92vw); height:auto; display:block; margin:0 auto}

/* 上部テキスト */
.counter{
  margin: 8px auto 6px;
  width:min(920px,92vw);
  font-weight:900;
  font-size: clamp(22px,3.0vw,32px);
}
.counter .num{letter-spacing:.06em}
.desc{margin: 2px 0 18px; font-size:.95rem; color:#555;}

.section-title{
  margin: 22px 0 34px;          /* 作品一覧の下に余裕 */
  font-size: clamp(18px,2.2vw,24px);
  font-weight:800;
}

/* 注意表示 */
.notice{
  background:#fff9e6; border:1px solid #f2e2b6; color:#7a5a00;
  width:min(1000px,92vw); margin:0 auto 16px; padding:12px 14px;
  border-radius:12px; text-align:left;
  display:none;
}

/* ========== Grid ========== */
/* PC=4列固定 / 中=3列 / SP=2列。最小幅を指定して重なり防止。 */
.gallery{
  width:min(1100px,96vw);
  margin:0 auto;
  display:grid;
  grid-template-columns: repeat(4, var(--card-w)); /* 4列固定 */
  justify-content:center;
  column-gap: var(--gap-x);
  row-gap: var(--gap-y);
  min-width: calc(var(--card-w) * 2 + var(--gap-x)); /* 2列を死守 */
  overflow-x:auto; /* 超狭い端末では横スクロールで護る */
}
@media (max-width:1100px){
  .gallery{ grid-template-columns: repeat(3, var(--card-w)); }
}
@media (max-width:860px){
  .gallery{ grid-template-columns: repeat(2, var(--card-w)); }
}
@media (max-width:560px){
  :root{ --card-w: 200px; --icon-size: 108px; --gap-x: 14px; --gap-y: 24px; }
}
@media (max-width:420px){
  :root{ --card-w: 188px; --icon-size: 102px; --gap-x: 12px; --gap-y: 22px; }
}

/* ========== card ========== */
.card{
  position:relative;
  background:#fff;
  width: var(--card-w);
  border-radius:18px;
  padding: 14px 10px 14px;       /* 上下の余白は同じ */
  box-shadow: var(--shadow);
  transition: box-shadow .2s ease, transform .2s ease;
  overflow: visible;             /* ポップアップが切れないように */
}
.card:hover{ box-shadow: var(--shadow-hover); transform: translateY(-2px); }

/* ========== icon ========== */
.icon-wrap{
  width: var(--icon-size);
  height: var(--icon-size);
  margin: 2px auto 0;
  border-radius:50%;
  overflow:hidden;
  border:4px solid rgba(103,167,186,.28);
  outline:2px solid var(--accent);
  outline-offset:-6px;
  background:#f3f4f6;
  position:relative;
  box-shadow: 0 0 0 rgba(0,0,0,0);
  transition: filter .18s, box-shadow .18s;
}
.card:hover .icon-wrap{
  box-shadow: 0 10px 22px rgba(103,167,186,.26); /* アイコンの影 */
}
.icon{width:100%; height:100%; object-fit:cover; display:block}

/* ========== popup ========== */
/* アイコンの“下 1/3”に重ねる。名前に被らず、行間は --gap-y で確保。 */
.pop{
  position:absolute;
  left:50%;
  top: calc(6px + var(--icon-size) * 0.78);
  transform: translate(-50%, -35%);
  display:flex; gap:10px; justify-content:center; align-items:center;
  padding:6px 8px;
  border-radius:12px;
  background:#fff;
  border:1px solid rgba(0,0,0,.08);
  box-shadow:0 10px 24px rgba(0,0,0,.14);
  z-index:10;
  opacity:0;
  pointer-events:none;
  transition: opacity .18s ease, transform .18s ease;
}
/* hover / タップ開閉 */
.card:hover .pop,
.card.pop-open .pop{ opacity:1; pointer-events:auto; }

/* ボタン（太字 & 指定色） */
.pill{
  display:inline-block;
  min-width:62px;
  padding:.36rem .68rem;
  border-radius:999px;
  line-height:1;
  border:1px solid var(--accent);
  color:var(--accent);
  background:#fff;
  text-decoration:none;
  font-size:.92rem;
  font-weight:700;          /* ←太文字 */
  white-space:nowrap;
  box-shadow:0 2px 0 rgba(103,167,186,.08);
  transition:background .12s, transform .06s;
}
.pill:hover{ background:rgba(103,167,186,.12) }
.pill:active{ transform:translateY(1px) }

/* ========== name ========== */
/* アイコンに近づけ、下側余白は上と同じに見える程度 */
.name{
  margin: 24px 0 2px;        /* アイコンとの距離だけ確保（下はカードpaddingで揃う） */
  font-weight:700;
  font-size:1.00rem;
}
.name a{ color:#111; text-decoration:none; }
.name a:focus-visible{ outline:2px solid var(--accent) }

/* footer */
footer{margin:26px 0 0; color:#666; font-size:.9rem}
</style>
</head>
<body>

<header>
  <img src="./assets/title.jpg" alt="雲隠深情">
</header>

<p class="counter">
  あなたは<strong class="num" id="visitor">000000</strong>人目の姑蘇藍氏の先輩
</p>
<p class="desc">お名前＝X、ポップアップのボタン＝作品・感想</p>

<h1 class="section-title">作品一覧</h1>

<p id="notice" class="notice"></p>

<section id="gallery" class="gallery" aria-live="polite"></section>

<footer>雲隠探情企画 / 主催はくと</footer>

<script>
/* ===== CSV（公開CSVのダウンロードURL） ===== */
const CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQLr1090BcgO8C08pdp3UHuN73zUFB68OyW47BSihAvvVxbwDtMBwK0st9tJpg8nqpNTR0m4QHjcVs4/pub?output=csv";

/* ===== 訪問カウンター ===== */
(() => {
  try{
    const el = document.getElementById('visitor');
    let n = Number(localStorage.getItem('mdzs_counter')||0) + 1;
    localStorage.setItem('mdzs_counter', n);
    el.textContent = String(n).padStart(6,'0');
  }catch(_){}
})();

/* ===== CSV 読み込み ===== */
async function loadCSV(url){
  const res = await fetch(url, {cache:'no-store'});
  const text = await res.text();
  const lines = text.replace(/^\uFEFF/,'').trim().split(/\r?\n/);
  if(lines.length===0) return [];
  const rawHeader = lines[0].split(',').map(s=>s.trim());
  const expected = ["アイコン","名前","ツイッター","作品","感想"];
  let header = rawHeader;
  let headerOK = expected.every((h,i)=>rawHeader[i]===h);
  if(!headerOK){
    const joined = rawHeader.join('/');
    if(joined !== expected.join('/')){
      header = expected;
      const n = document.getElementById('notice');
      n.style.display = 'block';
      n.textContent =
        "CSVの見出しが判定できなかったため、列の並び（アイコン/名前/ツイッター/作品/感想）で推測して読み込みました。見出しを付け直すとより安全です。";
    }
  }
  const rows = lines.slice(1).map(line=>{
    const cols = line.split(',').map(s=>s.trim());
    const obj = {};
    header.forEach((h,i)=> obj[h] = (cols[i] || "").trim());
    return obj;
  });
  return rows;
}

/* ===== カード生成 ===== */
function makeCard({アイコン, 名前, ツイッター, 作品, 感想}){
  const card = document.createElement('div');
  card.className = 'card';

  // アイコン
  const iconWrap = document.createElement('div');
  iconWrap.className = 'icon-wrap';
  const img = document.createElement('img');
  img.className = 'icon';
  img.alt = `${名前} のアイコン`;
  img.src = `./icons/${アイコン}`;
  iconWrap.appendChild(img);
  card.appendChild(iconWrap);

  // ポップアップ
  const pop = document.createElement('div');
  pop.className = 'pop';

  const toWork = document.createElement('a');
  toWork.className = 'pill';
  toWork.href = 作品 || '#';
  toWork.target = '_blank';
  toWork.rel = 'noopener';
  toWork.textContent = '作品';

  const toFb = document.createElement('a');
  toFb.className = 'pill';
  toFb.href = 感想 || '#';
  toFb.target = '_blank';
  toFb.rel = 'noopener';
  toFb.textContent = '感想';

  pop.appendChild(toWork);
  pop.appendChild(toFb);
  card.appendChild(pop);

  // 名前（黒リンク）
  const name = document.createElement('div');
  name.className = 'name';
  const tw = document.createElement('a');
  tw.href = ツイッター || '#';
  tw.target = '_blank';
  tw.rel = 'noopener';
  tw.textContent = 名前 || '';
  name.appendChild(tw);
  card.appendChild(name);

  // モバイル：タップで開閉
  iconWrap.addEventListener('click', (e)=>{
    e.preventDefault();
    e.stopPropagation();
    card.classList.toggle('pop-open');
  });
  iconWrap.tabIndex = 0;
  iconWrap.addEventListener('keydown', (e)=>{
    if(e.key==='Enter' || e.key===' '){
      e.preventDefault();
      card.classList.toggle('pop-open');
    }
  });
  document.addEventListener('click', (e)=>{
    if(!card.contains(e.target)) card.classList.remove('pop-open');
  });

  return card;
}

/* ===== init ===== */
(async ()=>{
  try{
    const rows = await loadCSV(CSV_URL);
    const wrap = document.getElementById('gallery');
    wrap.innerHTML = '';
    rows.slice(0,32).forEach(r => wrap.appendChild(makeCard(r))); // 4×8=32
  }catch(err){
    console.error(err);
    const n = document.getElementById('notice');
    n.style.display = 'block';
    n.textContent = 'CSVの読み込みに失敗しました。時間をおいて再読み込みしてください。';
  }
})();
</script>
</body>
</html>
