<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>雲隠深情 | 作品一覧</title>
<style>
:root{
  --accent: rgb(103,167,186);
  --shadow: 0 10px 24px rgba(0,0,0,.08);
  --shadow-hover: 0 18px 36px rgba(0,0,0,.14);
  --icon-size: 108px;
  --card-w: 200px;
  --gap: 16px;
}
*{box-sizing:border-box}
html,body{background:#fff;color:#222;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Sans",Meiryo,sans-serif}
body{margin:0;padding:0 0 64px;text-align:center}

/* header */
header{padding:22px 10px 8px}
header img{width:min(880px,92vw);height:auto;display:block;margin:0 auto}

/* 見出し/説明 */
.counter{ margin:8px auto 6px; width:min(920px,92vw); font-weight:900; font-size:clamp(22px,3.0vw,32px) }
.counter .num{letter-spacing:.06em}
.lead{margin:4px 0 0; font-size:1.15rem; color:#555;}
.section-title{ margin:18px 0 22px; font-size:clamp(20px,2.4vw,28px); font-weight:800; }
.notice{
  background:#fff9e6;border:1px solid #f2e2b6;color:#7a5a00;
  width:min(1000px,92vw);margin:0 auto 16px;padding:12px 14px;border-radius:12px;text-align:left;display:none;
}

/* Grid */
.wrap{ --wrap-w: calc(var(--card-w)*4 + var(--gap)*3); width:var(--wrap-w); max-width:100vw; margin:0 auto;
  overflow-x:auto; overflow-y:visible; padding:0 40px 56px; box-sizing:content-box; -ms-overflow-style:none; scrollbar-width:none; }
.wrap::-webkit-scrollbar{display:none}
.gallery{ display:grid; grid-template-columns:repeat(4,var(--card-w)); gap:var(--gap) }

/* モバイル2列 */
@media (max-width:860px) and (pointer:coarse){
  .wrap{ width:min(480px,96vw); overflow-x:hidden; padding:0 16px 48px }
  .gallery{ grid-template-columns:repeat(2,1fr); gap:16px }
  :root{ --icon-size:104px }
}

/* card */
.card{ position:relative; background:#fff; border-radius:16px; width:var(--card-w); padding:12px 8px 14px;
  box-shadow:var(--shadow); transition:box-shadow .2s, transform .2s }
.card:hover{ box-shadow:var(--shadow-hover); transform:translateY(-2px) }
@media (max-width:860px) and (pointer:coarse){ .card{ width:auto } }

/* icon */
.icon-wrap{ width:var(--icon-size); height:var(--icon-size); margin:2px auto 6px; border-radius:50%; overflow:hidden;
  border:4px solid rgba(103,167,186,.28); outline:2px solid var(--accent); outline-offset:-6px; background:#f3f4f6; position:relative; transition:filter .18s }
.icon-wrap:hover{ filter:saturate(1.04) }
.icon{ width:100%; height:100%; object-fit:cover; display:block }

/* popup */
.pop{ display:flex; gap:10px; justify-content:center; align-items:center; position:absolute; left:50%;
  top:calc(var(--icon-size)*0.83); transform:translate(-50%,-30%); padding:6px 8px; border-radius:12px; background:#fff;
  border:1px solid rgba(0,0,0,.08); box-shadow:0 10px 24px rgba(0,0,0,.14); z-index:10; opacity:0; pointer-events:none;
  transition:opacity .18s, transform .18s }
.card:hover .pop, .card.pop-open .pop{ opacity:1; pointer-events:auto }

/* button */
.pill{ display:inline-block; min-width:62px; padding:.36rem .66rem; border-radius:999px; line-height:1; border:1px solid var(--accent);
  color:var(--accent); background:#fff; text-decoration:none; font-size:.92rem; font-weight:700; white-space:nowrap; box-shadow:0 2px 0 rgba(103,167,186,.08);
  transition:background .12s, transform .06s }
.pill:hover{ background:rgba(103,167,186,.12) }
.pill:active{ transform:translateY(1px) }

/* name */
.name{ margin:18px 0 4px; font-weight:700; font-size:1.00rem }
.name a{ color:#111; text-decoration:none }
.name a:focus-visible{ outline:2px solid var(--accent) }

/* footer */
footer{ margin:28px 0 0; color:#666; font-size:.9rem }
</style>
</head>
<body>

<header>
  <img src="./assets/title.jpg" alt="雲隠深情">
</header>

<p class="counter">
  あなたは<strong class="num" id="visitor">000000</strong>人目の姑蘇藍氏の先輩
</p>
<p class="lead">お名前＝X、ポップアップのボタン＝作品・感想</p>
<p class="lead" style="color: blue;">ぜひ各作家さんに感想をお願いします！</p>
<h1 class="section-title">先輩との交流記録</h1>

<p id="notice" class="notice"></p>

<div class="wrap">
  <section id="gallery" class="gallery" aria-live="polite"></section>
</div>

<footer>雲隠探情企画 / 主催はくと</footer>

<script>
/* ===== 設定 ===== */
const CSV_URL =
  "https://docs.google.com/spreadsheets/d/1ommdqqp_b1cM439cTK3UekX-ADrla8ScEvjnnSJ14EY/export?format=csv&gid=0";

/* あなたの JSONP カウンターAPI（/exec） */
const COUNTER_API = "https://script.google.com/macros/s/AKfycbyp1U_pWMvHR9b1OaDkeA4WlAsfXK5uJoTyJLkDowRphl9CTruVkVYSi1iJ2ewrubr9/exec";

/* 固定表示したい時は6桁文字列、動的なら null */
const COUNTER_FIXED = null;

/* ===== CSV 読み込み ===== */
async function loadCSV(url){
  const res = await fetch(url, {cache:'no-store'});
  if (!res.ok) {
    console.error('CSV fetch failed:', res.status, res.url);
    const n = document.getElementById('notice');
    n.style.display = 'block';
    n.textContent = 'CSVの取得に失敗しました（' + res.status + '）。URL/公開設定をご確認ください。';
    return [];
  }

  const text = (await res.text()).replace(/^\uFEFF/,'').trim();
  if(!text) return [];

  const lines = text.split(/\r?\n/);
  const CSV_SPLIT = /,(?=(?:[^"]*"[^"]*")*[^"]*$)/;
  const stripQuotes = (s) => {
    const t = s.trim();
    if (t.startsWith('"') && t.endsWith('"')) return t.slice(1, -1).replace(/""/g, '"').trim();
    return t;
  };

  const rawHeader = lines[0].split(CSV_SPLIT).map(stripQuotes);
  console.info('[CSV header]', rawHeader);

  const headerMap = {アイコン:0, 名前:1, ツイッター:2, 作品:3, 感想:4};

  const rows = [];
  for (let i=1; i<lines.length; i++){
    const line = lines[i];
    if (!line || !line.trim()) continue;
    const cols = line.split(CSV_SPLIT).map(stripQuotes);
    rows.push({
      アイコン:   cols[headerMap['アイコン']]   || '',
      名前:       cols[headerMap['名前']]       || '',
      ツイッター: cols[headerMap['ツイッター']] || '',
      作品:       cols[headerMap['作品']]       || '',
      感想:       cols[headerMap['感想']]       || '',
    });
  }
  return rows;
}

/* ===== カード生成 ===== */
function makeCard({アイコン, 名前, ツイッター, 作品, 感想}){
  const card = document.createElement('div');
  card.className = 'card';

  const iconWrap = document.createElement('div');
  iconWrap.className = 'icon-wrap';
  const img = document.createElement('img');
  img.className = 'icon';
  img.alt = `${名前} のアイコン`;
  img.src = `./icons/${アイコン}`;
  iconWrap.appendChild(img);
  card.appendChild(iconWrap);

  const pop = document.createElement('div');
  pop.className = 'pop';
  const a1 = document.createElement('a');
  a1.className = 'pill'; a1.href = 作品 || '#'; a1.target = '_blank'; a1.rel = 'noopener'; a1.textContent = '作品';
  const a2 = document.createElement('a');
  a2.className = 'pill'; a2.href = 感想 || '#'; a2.target = '_blank'; a2.rel = 'noopener'; a2.textContent = '感想';
  pop.appendChild(a1); pop.appendChild(a2);
  card.appendChild(pop);

  const name = document.createElement('div');
  name.className = 'name';
  const tw = document.createElement('a');
  tw.href = ツイッター || '#'; tw.target = '_blank'; tw.rel = 'noopener'; tw.textContent = 名前 || '';
  name.appendChild(tw);
  card.appendChild(name);

  // モバイル：タップで開閉
  const toggle = (e)=>{ e.preventDefault(); e.stopPropagation(); card.classList.toggle('pop-open'); };
  iconWrap.addEventListener('click', toggle);
  iconWrap.tabIndex = 0;
  iconWrap.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ toggle(e); }});
  document.addEventListener('click', (e)=>{ if(!card.contains(e.target)) card.classList.remove('pop-open'); });

  return card;
}

/* ===== カウンター(JSONP) ===== */
function setCountText(n){
  document.getElementById('visitor').textContent = String(n).padStart(6,'0');
}

function jsonp(url){
  return new Promise((resolve, reject)=>{
    const cbName = 'cb_' + Math.random().toString(36).slice(2);
    window[cbName] = (data)=>{ resolve(data); cleanup(); };
    const s = document.createElement('script');
    s.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cbName;
    s.onerror = ()=>{ reject(new Error('JSONP error')); cleanup(); };
    document.body.appendChild(s);
    function cleanup(){ delete window[cbName]; s.remove(); }
  });
}

async function updateCounter(rows){
  if (COUNTER_FIXED && /^\d{6}$/.test(COUNTER_FIXED)) {
    setCountText(Number(COUNTER_FIXED)); return;
  }
  try{
    const getData = await jsonp(`${COUNTER_API}?action=get`);
    if (getData && typeof getData.count === 'number') setCountText(getData.count);
    const hitData = await jsonp(`${COUNTER_API}?action=hit`);
    if (hitData && typeof hitData.count === 'number') setCountText(hitData.count);
  }catch(_){
    setCountText(rows.length); // フォールバック
  }
}

/* ===== init ===== */
(async ()=>{
  try{
    const rows = await loadCSV(CSV_URL);
    const gallery = document.getElementById('gallery');
    gallery.innerHTML = '';
    rows.slice(0,32).forEach(r => gallery.appendChild(makeCard(r)));
    await updateCounter(rows);
  }catch(err){
    console.error(err);
    const n = document.getElementById('notice');
    n.style.display = 'block';
    n.textContent = 'CSVの読み込みに失敗しました。時間をおいて再読み込みしてください。';
  }
})();
</script>
</body>
</html>






