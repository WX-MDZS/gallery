<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>雲隠深情 | 作品一覧</title>
<style>
  :root{
    --bg:#fff;
    --ink:#111;
    --muted:#73808c;
    --ring:#8ec1d2;
    --pill: rgb(103,167,186); /* R103 G167 B186 */
    --shadow-card: 0 4px 18px rgba(0,0,0,.08);
    --shadow-card-hover: 0 10px 28px rgba(0,0,0,.12);
    --shadow-icon: 0 6px 18px rgba(0,0,0,.16);
  }
  *{ box-sizing:border-box; }
  html,body{ margin:0; background:var(--bg); color:var(--ink);
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;
    line-height:1.65;
  }
  a{ color:inherit; text-decoration:none; }

  header{ text-align:center; padding:28px 16px 8px; }
  header img{ width:min(860px,90vw); height:auto; display:block; margin:0 auto; }

  h2{ font-size:clamp(20px, 2.4vw, 28px); text-align:center; margin:14px 0 6px; }
  .desc, .counter{ text-align:center; color:var(--muted); }
  .counter{ margin:8px 0 18px; color:var(--ink); font-weight:600; }

  .wrap{ max-width:1120px; margin:0 auto; padding:0 16px 40px; }
  .gallery{
    display:grid; gap:22px;
    grid-template-columns:repeat(4,1fr);    /* PC固定4列 */
  }
  @media (max-width:720px){
    .wrap{ padding:0 14px 36px; }
    .gallery{ grid-template-columns:repeat(2,1fr); } /* スマホ固定2列 */
  }

  .card{
    position:relative; background:#fff; border-radius:18px;
    padding:16px 12px;
    display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
    gap:10px;                      /* 余白控えめ */
    min-height: 228px;             /* 正方形寄り & 余白の無駄を削る */
    box-shadow:var(--shadow-card);
    transition: box-shadow .18s ease, transform .18s ease;
  }
  .card:hover{ box-shadow:var(--shadow-card-hover); transform:translateY(-1px); }

  .icon-wrap{
    position:relative;
    display:inline-flex;
    padding-bottom: 72px;          /* ← ボタン領域ぶん確保（重なり防止） */
  }
  .icon{
    width:110px; height:110px; border-radius:50%; border:4px solid var(--ring);
    object-fit:cover; display:block;
    transition: transform .18s ease, filter .18s ease, box-shadow .18s ease;
  }
  .card:hover .icon{ transform: translateY(-1px) scale(1.02); box-shadow:var(--shadow-icon); filter:saturate(1.04); }

  /* ボタン：アイコンの下 / 名前の上（横並び） */
  .pop{
    position:absolute; left:50%; top:calc(100% + 10px); transform:translateX(-50%);
    display:flex; gap:10px; align-items:center; white-space:nowrap;
    pointer-events:none; opacity:0; transition:opacity .15s ease, transform .15s ease;
  }
  .card:hover .pop, .card:focus-within .pop{
    pointer-events:auto; opacity:1; transform:translateX(-50%) translateY(-2px);
  }
  .pill{
    display:inline-flex; align-items:center; justify-content:center;
    min-width:72px; height:36px; padding:0 12px;
    font-size:14px; border-radius:999px;
    border:1px solid var(--pill); color:var(--pill); background:#fff;
    box-shadow:0 2px 10px rgba(0,0,0,.06);
    transition:background .12s, color .12s, border-color .12s, transform .12s;
  }
  .pill:hover{ background:rgba(103,167,186,.12); transform:translateY(-1px); }

  .name{ font-size:15px; font-weight:700; color:#000; margin-top:4px; text-align:center; }
  .name a{ color:#000; }
  .name a:hover{ text-decoration:underline; text-underline-offset:3px; }

  .notice{
    max-width:880px; margin:14px auto 0; padding:12px 14px;
    border-radius:12px; background:#fff3f3; color:#a33; border:1px solid #f3caca;
    text-align:center; font-size:14px;
  }
</style>
</head>
<body>
  <header>
    <img src="assets/title.jpg" alt="雲隠深情">
  </header>

  <div class="wrap">
    <h2>作品一覧</h2>
    <p class="desc">アイコン＝Twitter、ポップアップのボタン＝作品・感想</p>
    <p class="counter">あなたは「<span id="visitor">000000</span>」人目の姑蘇藍氏の弟子</p>

    <div id="notice" class="notice" style="display:none;"></div>
    <div id="gallery" class="gallery" aria-live="polite"></div>

    <p style="text-align:center; margin:28px 0 8px; color:#666; font-size:14px;">雲隠探情企画 / 主催はくと</p>
  </div>

<script>
/* ====== 設定 ====== */
const CSV_URL =
  "https://docs.google.com/spreadsheets/d/1ommdqqp_b1cM439cTK3UekX-ADrla8ScEvjnnSJ14EY/export?format=csv";
const ICON_BASE = "assets/icons/";

/* ====== カウンタ ====== */
(function(){
  try{
    let n = +localStorage.getItem('visitCount') || 0;
    localStorage.setItem('visitCount', ++n);
    document.getElementById('visitor').textContent = String(n).padStart(6,'0');
  }catch(e){}
})();

/* ====== CSV 読み込み ====== */
const gallery = document.getElementById('gallery');
const notice  = document.getElementById('notice');

init();

async function init(){
  try{
    const text = await (await fetch(CSV_URL, {cache:'no-store'})).text();
    const rows = parseCSV(text);
    if(!rows.length) throw new Error('CSVに有効な行がありません');

    const map = normalizeHeader(rows[0]);
    let list = rows.slice(1).map(r => toRowObj(r, map)).filter(Boolean);

    // レスキュー：名前が画像ファイルでアイコン空ならスワップ
    list = list.map(fixRow);

    render(list);
  }catch(err){
    showErr('CSVは読み取れませんでした：' + err.message);
  }
}

function showErr(msg){
  notice.textContent = msg;
  notice.style.display = '';
}

/* ====== CSV utils ====== */
function parseCSV(text){
  const lines = text.replace(/\r/g,'').split('\n');
  return lines.map(line=>{
    if(!line.trim()) return null;
    const a=[]; let cur=''; let q=false;
    for(let i=0;i<line.length;i++){
      const c=line[i], n=line[i+1];
      if(q){
        if(c==='"' && n==='"'){ cur+='"'; i++; }
        else if(c==='"'){ q=false; }
        else cur+=c;
      }else{
        if(c==='"'){ q=true; }
        else if(c===','){ a.push(cur.trim()); cur=''; }
        else cur+=c;
      }
    }
    a.push(cur.trim());
    return a.every(v=>v==='') ? null : a;
  }).filter(Boolean);
}
const norm = s => (s||'').toString().trim().toLowerCase();
function normalizeHeader(headRow){
  const m={};
  headRow.forEach((h,i)=>{
    const k=norm(h);
    if(/^(name|名前)$/.test(k)) m.name=i;
    else if(/^(icon|アイコン|画像|image)$/.test(k)) m.icon=i;
    else if(/^(work|作品|link1)$/.test(k)) m.work=i;
    else if(/^(impression|感想|link2)$/.test(k)) m.impr=i;
    else if(/^(x|twitter|sns)$/.test(k)) m.x=i;
  });
  return m;
}
function toRowObj(row, map){
  if(!map) return null;
  const get = k => map[k]!=null ? (row[map[k]]||'').trim() : '';
  const obj = {
    name: get('name'),
    icon: get('icon'),
    work: get('work'),
    impr: get('impr'),
    x:    get('x')
  };
  // 全空は捨てる
  return (obj.name||obj.icon||obj.work||obj.impr||obj.x) ? obj : null;
}
function fixRow(r){
  // 「名前が画像、iconが空」→ スワップ
  if(!r.icon && /\.(png|jpe?g|webp|gif)$/i.test(r.name||'')){
    [r.icon, r.name] = [r.name, ''];
  }
  // 表示名が空ならXの末尾を仮名に
  if(!r.name && r.x){
    try{ r.name = decodeURIComponent(r.x.split('/').filter(Boolean).pop()||''); }catch(e){}
  }
  return r;
}
function resolveIcon(raw){
  let s = (raw||'').trim();
  if(!s) return '';
  if(/^https?:\/\//i.test(s)) return s;
  if(!/\.(png|jpe?g|webp|gif)$/i.test(s)) s += '.png';
  if(/^\.?\/?assets\//i.test(s)) return s.replace(/^\.?\//,'');
  return ICON_BASE + s.replace(/^\.?\//,'');
}

/* ====== 描画 ====== */
function render(list){
  gallery.innerHTML = '';
  const frag = document.createDocumentFragment();

  list.forEach(item=>{
    const card = el('div','card');

    const iconWrap = el('div','icon-wrap');
    const img = el('img','icon');
    const iconPath = resolveIcon(item.icon);

    img.src = iconPath || '';
    img.alt = (item.name||'') + ' のアイコン';

    const pop = el('div','pop');
    if(item.work){
      const a = el('a','pill','作品');
      a.href = item.work; a.target = '_blank'; a.rel='noopener';
      pop.appendChild(a);
    }
    if(item.impr){
      const a = el('a','pill','感想');
      a.href = item.impr; a.target = '_blank'; a.rel='noopener';
      pop.appendChild(a);
    }

    iconWrap.appendChild(img);
    iconWrap.appendChild(pop);
    card.appendChild(iconWrap);

    const name = el('div','name');
    if(item.x){
      const a = el('a',null, item.name||'—');
      a.href = item.x; a.target='_blank'; a.rel='noopener';
      name.appendChild(a);
    }else{
      name.textContent = item.name || '—';
    }
    card.appendChild(name);

    frag.appendChild(card);
  });

  gallery.appendChild(frag);
}

function el(tag, cls, text){
  const n = document.createElement(tag);
  if(cls) n.className = cls;
  if(text!=null) n.textContent = text;
  return n;
}
</script>
</body>
</html>
