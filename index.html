<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>雲隠深情 | 作品一覧</title>

<style>
  :root{
    /* テーマ色（R103 G167 B186） */
    --pill: rgb(103,167,186);
    --ring: #9cd1df;      /* アイコン縁の水色 */
    --shadow: 0 18px 40px rgba(0,0,0,.06);
    --text: #111;
    --muted:#666;
    --card: #fff;
    --bg: #fff;
    --radius: 16px;
  }

  /* リセット少々 */
  *{ box-sizing: border-box }
  html,body{ height:100% }
  body{
    margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans JP", "Yu Gothic", Meiryo, sans-serif;
    color:var(--text); background:var(--bg); -webkit-font-smoothing:antialiased;
  }

  header{ text-align:center; padding:24px 16px 4px }
  header img{ width:min(820px,92vw); height:auto; display:block; margin:0 auto }

  main{ max-width:1100px; margin:0 auto; padding:6px 14px 60px }

  h1{
    text-align:center; font-weight:800; letter-spacing:.04em;
    font-size: clamp(20px, 4vw, 28px);
    margin: 8px 0 4px;
  }
  .sub{
    text-align:center; color:var(--muted);
    font-size: clamp(12px, 2.8vw, 14px);
    margin: 0 0 12px;
  }

  /* カウンター行 */
  .counter{
    text-align:center; margin: 6px 0 24px; font-weight:700;
    font-size: clamp(14px, 2.8vw, 18px);
  }
  .counter .num{
    display:inline-block; font-variant-numeric: tabular-nums;
    letter-spacing:.06em; padding:0 .2em;
  }

  /* グリッド：PC4列 / SP2列 固定 */
  .gallery{
    display:grid; gap: 22px;
    grid-template-columns: repeat(4, 1fr);
  }
  @media (max-width: 720px){
    .gallery{ grid-template-columns: repeat(2, 1fr); gap: 18px }
  }

  /* カード（ほぼ正方形。幅に追従） */
  .card{
    position:relative; background:var(--card); border-radius: var(--radius);
    box-shadow: var(--shadow);
    height: clamp(210px, 29vw, 260px);
    display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
    transition: transform .12s ease;
  }
  .card:hover{ transform: translateY(-2px) }

  /* アイコン */
  .icon-wrap{ position:relative; margin-top: clamp(18px, 3.2vw, 22px); }
  .icon{
    width: clamp(108px, 13.5vw, 132px);
    height: clamp(108px, 13.5vw, 132px);
    display:block; border-radius:50%; object-fit:cover; background:#f3f4f6;
    border: 2px solid var(--ring);
    box-shadow: 0 0 0 4px rgba(156,209,223,.22);
    transition: filter .15s ease, transform .15s ease, box-shadow .15s ease;
  }
  /* 触ったら「影だけ」 */
  .card:hover .icon, .card:has(.pop-open) .icon, .card:focus-within .icon{
    filter: saturate(1.05) contrast(1.03);
    box-shadow: 0 12px 28px rgba(0,0,0,.10);
    transform: translateY(-2px);
  }

  /* ポップアップ：アイコン直下・横並び */
  .pop{
    position:absolute; left:50%; top: calc(100% + 8px);
    transform: translateX(-50%); display:flex; gap:10px;
    padding: 6px 10px; border-radius: 999px; background:#fff;
    border: 1px solid var(--ring);
    box-shadow: 0 10px 26px rgba(0,0,0,.08);
    opacity:0; pointer-events:none; transition: opacity .14s ease, transform .14s ease;
    z-index: 10;
  }
  .card:hover .pop, .card:has(.pop-open) .pop{ opacity:1; pointer-events:auto; transform: translateX(-50%) translateY(-2px) }

  .pill{
    display:inline-block; min-width:64px; text-align:center;
    padding: .38rem .7rem; border-radius:999px; font-size: .92rem;
    color:var(--pill); text-decoration:none; border:1px solid var(--pill); background:#fff;
    transition: background .12s, color .12s, border-color .12s;
  }
  .pill:hover{ background: rgba(103,167,186,.12) }

  /* 名前＝Twitterへ（黒のまま・下線なし） */
  .name{
    margin: 14px 0 0; font-weight:700; font-size: clamp(14px, 2.9vw, 18px);
  }
  .name a{
    color: var(--text); text-decoration:none;
    border-bottom:1px solid transparent; transition: border-color .12s;
  }
  .name a:hover{ border-color: rgba(17,17,17,.25) }

  footer{ text-align:center; color:#777; font-size:.9rem; margin: 34px 0 46px }
</style>
</head>

<body>
  <header>
    <!-- ロゴは相対パス（先頭スラッシュなし） -->
    <img src="assets/title.jpg" alt="雲隠深情">
  </header>

  <main>
    <h1>作品一覧</h1>
    <p class="sub">アイコン＝Twitter、ポップアップのボタン＝作品・感想</p>

    <p class="counter">あなたは「<span id="visitor" class="num">000000</span>」人目の姑蘇藍氏の弟子</p>

    <section id="gallery" class="gallery" aria-live="polite">
      <!-- JSでカード自動生成 -->
    </section>

    <footer>雲隠探情企画 / 主催はくと</footer>
  </main>

<script>
/* ========== 設定 ========== */
/* 公開CSVのURLを入れてください（「ウェブに公開」→ CSV） */
const CSV_URL =
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vQLr1090BcgO8C08pdp3UHuN73zUFB68OyW47BSihAvvVxbwDtMBwK0st9tJpg8nqpNTR0m4QHjcVs4/pub?gid=0&single=true&output=csv';

/* ========== 訪問カウンター ========== */
(function () {
  const el = document.getElementById('visitor');
  let n = +(localStorage.getItem('visitCount') || 0);
  n++;
  localStorage.setItem('visitCount', String(n));
  el.textContent = String(n).padStart(6, '0');
})();

/* ========== CSVを取ってカード生成 ========== */
const $g = document.getElementById('gallery');

async function loadCSV(url){
  const res = await fetch(url, { cache:'no-store' });
  const text = await res.text();

  // CSVパース（ダブルクオート対応の簡易版）
  const rows = [];
  let i=0, cell='', row=[], inQ=false;
  while(i<text.length){
    const c = text[i];
    if(inQ){
      if(c === '"'){
        if(text[i+1] === '"'){ cell += '"'; i++; }
        else { inQ = false; }
      } else { cell += c; }
    }else{
      if(c === '"'){ inQ = true; }
      else if(c === ','){ row.push(cell); cell=''; }
      else if(c === '\n' || c === '\r'){
        if(c === '\r' && text[i+1] === '\n') i++;
        row.push(cell); rows.push(row); cell=''; row=[];
      } else { cell += c; }
    }
    i++;
  }
  if(cell.length || row.length){ row.push(cell); rows.push(row); }

  // 1行目がヘッダーなら弾く（A列に「A」「アイコン」など文字ヘッダーらしきもの）
  const looksHeader = rows[0] && /^[a-zA-Zａ-ｚＡ-Ｚぁ-んァ-ン一-龥]/.test((rows[0][0]||'').trim());
  const data = looksHeader ? rows.slice(1) : rows;

  // 空行は除外（A/B/Cいずれも空）
  return data.filter(r => (r[0]||r[1]||r[2]||r[3]||r[4]||'').trim() !== '');
}

function toIconPath(a){
  // A列が "01" なら icons/01.png、"01.png" ならそのまま
  const v = (a||'').trim();
  if(!v) return 'icons/placeholder.png'; // 予備（置いてなくてもonerrorで処理）
  return v.match(/\.(png|jpg|jpeg|webp|gif)$/i) ? `icons/${v}` : `icons/${v}.png`;
}

function createCard({icon, name, twitter, work, feedback}){
  const card = document.createElement('article');
  card.className = 'card';

  // アイコン（リンク化しない）
  const wrap = document.createElement('div');
  wrap.className = 'icon-wrap';
  const img = document.createElement('img');
  img.className = 'icon';
  img.alt = name || '';
  img.src = toIconPath(icon);
  img.referrerPolicy = 'no-referrer';

  // 読み込み失敗フォールバック（崩れ防止）
  img.onerror = () => {
    img.onerror = null;
    img.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==';
  };

  // ポップアップ（横並び）
  const pop = document.createElement('div');
  pop.className = 'pop';

  const aWork = document.createElement('a');
  aWork.className = 'pill';
  aWork.textContent = '作品';
  aWork.href = work || '#';
  aWork.target = '_blank'; aWork.rel = 'noopener';

  const aFb = document.createElement('a');
  aFb.className = 'pill';
  aFb.textContent = '感想';
  aFb.href = feedback || '#';
  aFb.target = '_blank'; aFb.rel = 'noopener';

  pop.append(aWork, aFb);
  wrap.append(img, pop);
  card.append(wrap);

  // 名前（= Twitter へ。色は黒のまま）
  const nameEl = document.createElement('div');
  nameEl.className = 'name';
  const tw = document.createElement('a');
  tw.textContent = name || '';
  tw.href = twitter || '#';
  tw.target = '_blank'; tw.rel = 'noopener';
  nameEl.append(tw);
  card.append(nameEl);

  // タップで開閉（モバイル考慮）
  let opened = false;
  const open = () => { if(!opened){ pop.classList.add('pop-open'); opened=true; } };
  const close = () => { if(opened){ pop.classList.remove('pop-open'); opened=false; } };

  // カード内のタップで開閉（アイコンをリンクにしない）
  card.addEventListener('touchstart', (e)=>{ open(); }, {passive:true});
  // 画面外タップで閉じる
  document.addEventListener('touchstart', (e)=>{
    if(!card.contains(e.target)) close();
  }, {passive:true});

  // マウス: ホバーで表示
  card.addEventListener('mouseenter', open);
  card.addEventListener('mouseleave', close);

  return card;
}

(async function init(){
  try{
    const rows = await loadCSV(CSV_URL);
    // A:アイコン名 / B:名前 / C:Twitter / D:作品 / E:感想
    rows.forEach((r)=>{
      const card = createCard({
        icon:     r[0],
        name:     r[1],
        twitter:  r[2],
        work:     r[3],
        feedback: r[4]
      });
      $g.append(card);
    });
  }catch(err){
    console.error('CSV 読み込みエラー', err);
    $g.innerHTML = `<p style="grid-column:1/-1;color:#b00;text-align:center">データを読み込めませんでした。</p>`;
  }
})();
</script>
</body>
</html>
