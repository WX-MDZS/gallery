<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="Cache-Control" content="no-store, max-age=0" />
<title>雲隠深情</title>
<style>
  :root{
    --accent: rgb(103,167,186); /* R103 G167 B186 */
    --ring:   #cfe6f0;
    --ink:    #222;
    --shadow: 0 8px 20px rgba(0,0,0,.10);
  }
  *{ box-sizing:border-box }
  body{
    margin:0;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto,
      "Hiragino Sans","Noto Sans JP","Yu Gothic", Meiryo, sans-serif;
    color:var(--ink); text-align:center; background:#fff;
  }
  header{ padding:24px 12px 8px }
  header img{ max-width:920px; width:92%; height:auto; display:block; margin:0 auto }
  h2{ margin:8px 0 4px; font-size:clamp(18px,2.8vw,26px) }
  .description{ color:#555; font-size:.95rem; margin:2px 0 6px }
  .counter{ font-weight:700; margin:8px 0 22px; font-size:clamp(16px,2.3vw,20px) }

  /* 4×8 固定（PC）、スマホは2列 */
  .grid{
    display:grid; gap:24px;
    grid-template-columns:repeat(4,1fr);
    max-width:980px; margin:0 auto 44px; padding:0 16px;
  }
  @media (max-width:640px){
    .grid{ grid-template-columns:repeat(2,1fr); gap:18px }
  }

  .card{
    position:relative; background:#fff; border-radius:16px;
    box-shadow:0 2px 10px rgba(0,0,0,.08);
    padding:14px 10px 22px; transition:transform .12s ease;
  }
  .card:hover{ transform:translateY(-2px) }

  .icon-wrap{ position:relative; display:inline-block }
  .icon{
    width:120px; height:120px; border-radius:50%; object-fit:cover;
    border:2px solid var(--ring); display:block; margin:6px auto 8px;
    box-shadow:0 6px 12px rgba(0,0,0,.06);
    transition:transform .18s ease, box-shadow .18s ease;
  }
  .card:hover .icon, .card:focus-within .icon{
    transform:scale(1.04); box-shadow:0 12px 24px rgba(0,0,0,.12);
  }

  .name{
    font-weight:700; margin-bottom:12px;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }

  /* ポップアップ */
  .pop{
    position:absolute; left:50%; bottom:14px;
    transform:translateX(-50%) translateY(6px) scale(.98);
    opacity:0; pointer-events:none;
    background:#fff; border:1px solid var(--ring); border-radius:12px;
    padding:.5rem .6rem; white-space:nowrap; z-index:10;
    box-shadow:var(--shadow); transition:opacity .15s, transform .15s;
  }
  .card:hover .pop, .card:focus-within .pop, .card.pop-open .pop{
    opacity:1; transform:translateX(-50%) translateY(0) scale(1);
    pointer-events:auto;
  }

  .pill{
    display:inline-block; font-size:.9rem; padding:.35rem .7rem; margin:0 .2rem;
    border-radius:999px; text-decoration:none;
    border:1px solid var(--accent); color:var(--accent); background:#f8fafc;
    transition:background .12s, border-color .12s, color .12s;
  }
  .pill:hover{ background:rgba(103,167,186,.15) }

  .icon-link:focus-visible, .pill:focus-visible{
    outline:2px solid var(--accent); outline-offset:2px; border-radius:12px;
  }

  footer{ margin:28px 0 22px; color:#666; font-size:.9rem }
</style>
</head>
<body>

<header>
  <img src="assets/title.jpg" alt="雲隠深情">
</header>

<h2>作品一覧</h2>
<p class="description">アイコン＝X、ポップアップのボタン＝作品・感想</p>
<p class="counter">あなたは「<span id="visitor-count">000000</span>」人目の姑蘇藍氏の弟子</p>

<div id="grid" class="grid" aria-live="polite"></div>

<footer>雲隠探情企画 / 主催はくと</footer>

<script>
  /******** 訪問カウンター ********/
  const counterEl = document.getElementById('visitor-count');
  let count = Number(localStorage.getItem('visitCount') || 0) + 1;
  localStorage.setItem('visitCount', count);
  counterEl.textContent = String(count).padStart(6, '0');

  /******** CSV の URL（あなたの公開CSVに差し替え） ********/
  const CSV_URL =
    'https://docs.google.com/spreadsheets/d/e/2PACX-1vQLr1090BcgO8C08pdp3UHuN73zUFB68OyW47BSihAvvVxbwDtMBwK0st9tJpg8nqpNTR0m4QHjcVs4/pub?gid=0&single=true&output=csv';

  /******** シンプルCSVパーサ（" を考慮） ********/
  function parseCSV(text){
    const rows=[]; let i=0, field='', row=[], inQ=false;
    while(i<text.length){
      const c=text[i];
      if(inQ){
        if(c=='"'){ if(text[i+1]=='"'){ field+='"'; i++; } else inQ=false; }
        else field+=c;
      }else{
        if(c=='"') inQ=true;
        else if(c==','){ row.push(field); field=''; }
        else if(c=='\n'||c=='\r'){ if(field!==''||row.length){ row.push(field); rows.push(row); }
          field=''; row=[]; if(c=='\r'&&text[i+1]=='\n') i++; }
        else field+=c;
      }
      i++;
    }
    if(field!==''||row.length){ row.push(field); rows.push(row); }
    return rows;
  }

  /******** カード生成 ********/
  function makeCard({icon,name,x,work,feedback}){
    const hasExt = /\.[a-zA-Z0-9]+$/.test(icon);
    const iconPath = 'icons/' + icon + (hasExt ? '' : '.png');

    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="icon-wrap">
        <a class="icon-link" href="${x || '#'}" target="_blank" rel="noopener" aria-label="${name} のXへ">
          <img class="icon" src="${iconPath}" alt="${name}">
        </a>
      </div>
      <div class="name">${name || ''}</div>
      <div class="pop" role="dialog" aria-label="${name} のメニュー">
        <a class="pill" href="${work || '#'}" target="_blank" rel="noopener">作品へ</a>
        <a class="pill" href="${feedback || '#'}" target="_blank" rel="noopener">感想へ</a>
      </div>
    `;
    return card;
  }

  /******** 読み込み → 4×8=32人 ********/
  async function init(){
    const grid = document.getElementById('grid');
    grid.textContent = '読み込み中…';
    try{
      const res  = await fetch(CSV_URL, {cache:'no-store'});
      const text = await res.text();
      const rows = parseCSV(text);
      const data = rows.slice(1).map(r=>({
        icon:(r[0]||'').trim(),
        name:(r[1]||'').trim(),
        x:(r[2]||'').trim(),
        work:(r[3]||'').trim(),
        feedback:(r[4]||'').trim(),
      })).slice(0,32);

      grid.textContent='';
      data.forEach(item => grid.appendChild(makeCard(item)));

      /***** タッチ：リンクはブロックしない。カード(空白部)タップで開閉だけ *****/
      document.querySelectorAll('.card').forEach(card=>{
        card.addEventListener('touchstart', e=>{
          const onLink = e.target.closest('a'); // アイコン or ボタン
          if(onLink) return; // ← リンクはそのまま遷移

          // 空白部をタップしたら「開く」だけ（既に開いていれば何もしない）
          if(!card.classList.contains('pop-open')){
            document.querySelectorAll('.card.pop-open').forEach(c=>c.classList.remove('pop-open'));
            card.classList.add('pop-open');
            e.preventDefault(); // ← ここでスクロール抑止のみ
          }
        }, {passive:false});
      });

      // 外側タップで閉じる
      document.addEventListener('touchstart', e=>{
        if(!e.target.closest('.card')){
          document.querySelectorAll('.card.pop-open').forEach(c=>c.classList.remove('pop-open'));
        }
      }, {passive:true});

      // ESCで閉じる（キーボード）
      document.addEventListener('keydown', e=>{
        if(e.key==='Escape'){
          document.querySelectorAll('.card.pop-open').forEach(c=>c.classList.remove('pop-open'));
        }
      });
    }catch(err){
      console.error(err);
      grid.textContent = '読み込みでエラーが発生しました。CSVの公開設定とURLをご確認ください。';
    }
  }
  init();
</script>

</body>
</html>
